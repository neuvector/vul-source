import json
import pytest
import os
from test_utils import TestUtilities as util

from datalib import (
    ReleaseStorage,
    UCTCVEStorage,
    UCTPackageStorage,
    USNStorage,
    LSNStorage,
)

from data_generation.osv_lib import cve2osv, usn2osv, lsn2osv

if 'UCT' not in os.environ:
    raise Exception("missing UCT in environment")

release_storage = ReleaseStorage()
supported_releases = release_storage.gen_data_releases

cve_storage = UCTCVEStorage()
cve_storage.link_release_storage(release_storage)
cve_storage.load()

package_storage = UCTPackageStorage()
package_storage.link_release_storage(release_storage)
package_storage.load(filter_releases=supported_releases['osv'])
cve_storage.link_pkg_storage(package_storage)

usn_storage = USNStorage()
usn_storage.link_release_storage(release_storage)
usn_storage.load()
usn_storage.link_pkg_storage(package_storage)
usn_storage.link_cve_storage(cve_storage)

lsn_storage = LSNStorage()
lsn_storage.link_release_storage(release_storage)
lsn_storage.load()
lsn_storage.link_pkg_storage(package_storage)
lsn_storage.link_cve_storage(cve_storage)


class TestMockData:
    @pytest.mark.parametrize(
        "cve_id", [("CVE-0000-0001"), ("CVE-0000-0002"), ("CVE-0000-0003")]
    )
    def test_gold_cves(self, cve_id):
        output_file = "./ubuntu/osv/cve/0000/UBUNTU-" + cve_id + ".json"
        util.files_to_del.add(output_file)
        cve_storage.load_cve(os.environ['UCT'] + "/test/osv/gold_cve_files/" + cve_id)
        cve2osv("./", cve_storage.get_cve(cve_id), supported_releases)
        test_json = json.load(open(output_file))
        test_json['modified'] = ''
        gold_json = json.load(open(os.environ['UCT'] + "/test/osv/gold_osv_files/UBUNTU-" + cve_id + ".json"))
        gold_json['modified'] = ''
        assert test_json == gold_json

    @pytest.mark.parametrize(
        "usn_id", [("2169-1"), ("6850-1"), ("6246-1")]
    )
    def test_gold_usns(self, usn_id):
        output_file = "./ubuntu/osv/usn/USN-" + usn_id + ".json"
        util.files_to_del.add(output_file)
        usn = usn_storage.get_usn(usn_id)
        usn2osv("./", usn)
        gold_json = json.load(open(os.environ["UCT"] + "/test/osv/gold_osv_files/USN-" + usn_id + ".json"))
        assert json.load(open(output_file)) == gold_json

    @pytest.mark.parametrize(
        "lsn_id", [("LSN-0101-1"), ("LSN-0097-1"), ("LSN-0074-1")]
    )
    def test_gold_lsns(self, lsn_id):
        output_file = "./ubuntu/osv/lsn/" + lsn_id + ".json"
        util.files_to_del.add(output_file)
        lsn = lsn_storage.get_lsn(lsn_id)
        lsn2osv("./", lsn)
        gold_json = json.load(open(os.environ["UCT"] + "/test/osv/gold_osv_files/" + lsn_id + ".json"))
        assert json.load(open(output_file)) == gold_json
