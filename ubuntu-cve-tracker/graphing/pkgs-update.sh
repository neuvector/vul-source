#!/bin/bash
#
# SPDX-License-Identifier: GPL-3.0-only
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# report and graph CVE counts per release per package.
#
# Author: Steve Beattie <steve.beattie@canonical.com>
# Author: Emily Ratliff <emily.ratliff@canonical.com>
# Copyright 2010 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.

set -e
export UCT=/home/ubuntu-security/git-pulls/cve-tracker
REVIEWED=/home/ubuntu-security/reviewed

cd /home/ubuntu-security/graphing

# Affected software counts
export NAMED=10
echo '<html><head><title>CVE counts per release per package</title></head><body>' > ~/public_html/graphs/pkgs-report.html.new
for REL in $(./supported-list.py | tac) ; do
	export REL

	SPECIFIC=$( (cd "$REVIEWED" && ./scripts/report-packages.py --action plot $REL) | sort -n -k 8 | awk '{print $1 " " $8}' | tail -n $NAMED)
	if [ -n "$SPECIFIC" ]; then
		OTHERS=$( (cd "$REVIEWED" && ./scripts/report-packages.py --action plot $REL) | sort -n -k 8 | head -n -$NAMED | awk '{ sum+=$8 }END{print sum}' )
		export SPECIFIC
		export OTHERS

		(
		echo "$SPECIFIC"
		if [ -n "$OTHERS" ]; then
			echo "others $OTHERS"
		fi
		) | "$REVIEWED"/scripts/pie-chart.py pkgs-$REL.png "$REL CVE fixes published per package"

		echo '<img src="'pkgs-$REL.png'" /><hr />' >> ~/public_html/graphs/pkgs-report.html.new
		cp pkgs-$REL.png ~/public_html/graphs/
	fi
done
echo '</body></html>' >> ~/public_html/graphs/pkgs-report.html.new
mv ~/public_html/graphs/pkgs-report.html.new ~/public_html/graphs/pkgs-report.html
