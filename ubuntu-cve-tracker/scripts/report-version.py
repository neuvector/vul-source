#!/usr/bin/env python2
#
# SPDX-License-Identifier: GPL-3.0-only 
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# report the latest version of a given source packages known to the USN db.
#
# Author: Kees Cook <kees@ubuntu.com>
# Copyright 2011 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.


# ./scripts/report-version.py linux precise

from __future__ import print_function

import os
import sys
import optparse
import cve_lib
import usn_lib
from uct.config import read_uct_config

import apt_pkg
apt_pkg.init_system()

releases = cve_lib.releases
esm_releases = cve_lib.esm_releases + cve_lib.esm_infra_releases
config = read_uct_config()

parser = optparse.OptionParser()
parser.add_option("--db", help="Specify the USN database to load", metavar="FILENAME", default=config['usn_db_copy'])
parser.add_option("-d", "--debug", help="Report debug information while loading", action="store_true")
(opt, args) = parser.parse_args()

if not os.path.exists(opt.db):
    print("Cannot read %s" % (opt.db), file=sys.stderr)
    sys.exit(1)
db = usn_lib.load_database(opt.db)

releases = cve_lib.releases
for eol in cve_lib.eol_releases:
    if eol in releases:
        releases.remove(eol)
if len(cve_lib.devel_release) > 0:
    releases.remove(cve_lib.devel_release)

src = args[0]

release = None
if len(args) > 1:
    release = args[1]
if release and release not in releases and release not in esm_releases:
    raise ValueError("'%s' must be one of '%s'" % (release, "', '".join(releases + esm_releases)))

highest = '~'
for usn in sorted(db.keys()):
    if not release or release in db[usn]['releases']:
        for rel in db[usn]['releases']:
            if not release or release == rel:
                if 'sources' in db[usn]['releases'][rel]:
                    if src in db[usn]['releases'][rel]['sources']:
                        version = db[usn]['releases'][rel]['sources'][src]['version']
                        if apt_pkg.version_compare(version, highest) > 0:
                            highest = version

print(highest)
