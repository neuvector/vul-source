#!/usr/bin/env python2
#
# SPDX-License-Identifier: GPL-3.0-only
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# look for active CVEs that have open packages in main/restricted that are no
# longer supported (e.g. LTS end-of-life).
#
# Author: Tyler Hicks <tyhicks@canonical.com>
# Copyright 2017 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.


from __future__ import print_function
import glob
import optparse
import os
import os.path
import sys

import cve_lib
import source_map

parser = optparse.OptionParser()
parser.add_option("-p", "--package", dest="package", default=None, help="Source package to abandon.")
parser.add_option("-r", "--release", dest="release", default=None, help="Only abandon the package in the specified release. The default is to abandon the package in all releases.")
parser.add_option("-u", "--update", dest="update", help="Make changes to CVE files. The default is to only report changes that would be made.", action='store_true')
(opt, args) = parser.parse_args()

if not opt.package:
    print("ERROR: must specify a source package", file=sys.stderr)
    sys.exit(1)

src = opt.package
pkgs = source_map.load()

cves = glob.glob('%s/CVE-*' % cve_lib.active_dir)
if os.path.islink('embargoed'):
    cves += glob.glob('embargoed/CVE-*')
    cves += glob.glob('embargoed/EMB-*')

for filename in cves:
    cve = os.path.basename(filename)
    try:
        data = cve_lib.load_cve(filename)
    except ValueError as e:
        if not cve.startswith('EMB'):
            print(e, file=sys.stderr)
        continue

    if src not in data['pkgs']:
        continue

    if opt.release:
        if opt.release not in data['pkgs'][src]:
            continue

        releases = [opt.release]
    else:
        releases = data['pkgs'][src].keys()
        if 'upstream' in releases:
            releases.remove('upstream')

    for release in releases:
        state = data['pkgs'][src][release][0]
        open_states = ['needed', 'needs-triage', 'deferred']

        if state not in open_states:
            continue

        print('%s: %s abandoned (%s)' % (cve, src, release))

        if opt.update:
            cve_lib.update_state(filename, src, release, 'ignored', 'abandoned')
