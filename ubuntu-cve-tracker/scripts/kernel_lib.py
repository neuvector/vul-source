#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# Author: Kees Cook <kees@ubuntu.com>
# Author: Jamie Strandboge <jamie@ubuntu.com>
# Author: Steve Beattie <sbeattie@ubuntu.com>
# Copyright (C) 2005-2024 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 3 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.
#
# Helper functions and data structures for dealing with the kernel
# packages, which are very very special.
from __future__ import print_function

import sys
import os
import re
import urllib.error
import urllib.request
from uct.config import read_uct_config
from source_map import version_compare

# XXX kernel_srcs probably belongs here, too
from cve_lib import (kernel_srcs, get_esm_name, is_active_esm_release, \
                     load_cve, find_cve, load_json_file_overrides, cmd)


# search for the kernel SRU cycle for a kernel in the format
# "linux[-complement]: <version>"
def get_kernel_sru_cycle(kernel_title, debug, lp):
    cycle = None
    kernels = lp.projects['kernel-sru-workflow']
    tasks = kernels.searchTasks(omit_targeted=False, search_text=kernel_title,
                                status=["New", "Confirmed", "Triaged", "In Progress", "Fix Committed", "Fix Released"])

    if debug:
        print('found %d results: for %s' % (len(tasks), kernel_title), file=sys.stderr)

    for task in tasks:
        if debug:
            print(' LP#%d: %s' % (task.bug.id, task.bug.title), file=sys.stderr)

        # re-search for the exact text in the title as the first search
        # in searchTasks() can return similarities
        if kernel_title in task.bug.title:
            for tag in task.bug.tags:
                if tag.startswith("kernel-sru-cycle-"):
                    cycle = tag.split('-', maxsplit=3)[3]
                    break
            break

    return cycle


# converts a kernel source package name to the signed version, based off
# of the default naming style linux-FOO -> linux-signed-FOO
def convert_name_to_signed(kernel):
    if not kernel.startswith('linux'):
        raise ValueError("received non-kernel source name: %s" % kernel)
    return 'linux-signed' + kernel[5:]

# converts a kernel source package name to the meta version, based off
# of the default naming style linux-FOO -> linux-meta-FOO
def convert_name_to_meta(kernel):
    if not kernel.startswith('linux'):
        raise ValueError("received non-kernel source name: %s" % kernel)
    return 'linux-meta' + kernel[5:]

class MetaKernelTable(object):

    def __init__(self):
        self.table = dict()

    # sources is expected to a be a list, the primary kernel first
    # e.g. add_new_kernel('precise', ['linux', 'lbm-3.2'], '-3.2.0')
    def add_new_kernel(self, release, sources, suffix, signed='DEFAULT', ignore_usn=False, ignore_mabi=False, ppa=None):
        if release not in self.table:
            self.table[release] = dict()
        (primary, subordinates) = (sources[0], sources[1:])
        self.table[release][primary] = dict()
        self.table[release][primary]['suffix'] = suffix
        self.table[release][primary]['meta'] = convert_name_to_meta(primary)
        self.table[release][primary]['subordinates'] = subordinates
        if signed == 'DEFAULT':
            self.table[release][primary]['signed'] = convert_name_to_signed(primary)
        else:
            self.table[release][primary]['signed'] = signed
        self.table[release][primary]['ignore_usn'] = ignore_usn
        self.table[release][primary]['ignore_mabi'] = ignore_mabi
        # None here equals the ubuntu archive
        self.table[release][primary]['ppa'] = ppa

    # wrapper function for edge kernels
    # XXX the better way to identify if a kernel is an edge kernel is to
    # determine if the meta source package provides a regular meta
    # package or an edge meta package, which will require a launchpad
    # lookup (sigh).
    def add_new_edge_kernel(self, release, sources, suffix, signed='DEFAULT'):
        self.add_new_kernel(release, sources, suffix, signed, ignore_usn=True, ignore_mabi=True)

    def consistency_check(self):
        kernels = set()
        if sys.version_info[0] == 3:
            for release in iter(self.table.values()):
                kernels.update(release.keys())
        else:
            for release in self.table.itervalues():
                kernels.update(release.keys())

        if not kernels.issubset(kernel_srcs):
            print('WARNING: MetaKernelTable contains the following kernels not in kernel_sources: ' +
                  '%s' % ' '.join(kernels.difference(kernel_srcs)))

    def _get_attribute(self, attribute, release, kernel):
        if release in self.table and kernel in self.table[release]:
            return self.table[release][kernel][attribute]
        # we try a fallback here for esm kernels, to ensure that either
        # looking up trusty/esm or trusty will get the right attribute.
        # XXX This could be a problem if we have some kernels in a ppa
        # and some not for a given release.
        elif is_active_esm_release(release):
            esm_release = get_esm_name(release)
            if esm_release in self.table and kernel in self.table[esm_release]:
                return self.table[esm_release][kernel][attribute]
        return None

    def get_meta(self, release, kernel, quiet=False):
        meta = self._get_attribute('meta', release, kernel)
        if not meta and not quiet:
            print("Unable to find meta kernel for kernel %s/%s" % (kernel, release), file=sys.stderr)
        return meta

    def get_signed(self, release, kernel, quiet=False):
        signed = self._get_attribute('signed', release, kernel)
        if not signed and not quiet:
            print("Unable to find signed kernel for kernel %s/%s" % (kernel, release), file=sys.stderr)
        return signed

    def get_ppa(self, kernel, release, quiet=True):
        ppa = self._get_attribute('ppa', release, kernel)
        if not ppa and not quiet:
            print("Unable to find ppa for kernel %s/%s" % (kernel, release), file=sys.stderr)
        return ppa

    def get_next_kernel(self):
        for release in self.table:
            for kernel in self.table[release]:
                srcs = [kernel]
                if len(self.table[release][kernel]['subordinates']) > 0:
                    srcs.extend(self.table[release][kernel]['subordinates'])
                meta = self.table[release][kernel]['meta']
                signed = self.table[release][kernel]['signed']
                yield (release, srcs, meta, signed)

    def ignore_usn(self, release, kernel):
        return self.table[release][kernel]['ignore_usn']

    def ignore_mabi(self, release, kernel):
        return self.table[release][kernel]['ignore_mabi']


meta_kernels = MetaKernelTable()
meta_kernels.add_new_kernel('trusty/esm', ['linux'], '-3.13.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('trusty/esm', ['linux-lts-xenial'], '-4.4.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('trusty/esm', ['linux-azure'], '-4.15.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('trusty/esm', ['linux-aws'], '-4.4.0', signed=False, ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra-legacy/trusty', ['linux'], '-3.13.0', ppa='ubuntu-esm/esm-infra-legacy-security')
meta_kernels.add_new_kernel('esm-infra-legacy/trusty', ['linux-lts-xenial'], '-4.4.0', ppa='ubuntu-esm/esm-infra-legacy-security')
meta_kernels.add_new_kernel('esm-infra-legacy/trusty', ['linux-azure'], '-4.15.0', ppa='ubuntu-esm/esm-infra-legacy-security')
meta_kernels.add_new_kernel('esm-infra-legacy/trusty', ['linux-aws'], '-4.4.0', signed=False, ppa='ubuntu-esm/esm-infra-legacy-security')
meta_kernels.add_new_kernel('xenial', ['linux'], '-4.4.0')
meta_kernels.add_new_kernel('xenial', ['linux-raspi2'], '-4.4.0', signed=False)
meta_kernels.add_new_kernel('xenial', ['linux-aws'], '-4.4.0', signed=False)
meta_kernels.add_new_kernel('xenial', ['linux-aws-hwe'], '-4.15.0')
meta_kernels.add_new_kernel('xenial', ['linux-azure'], '-4.11.0')   # suffix may need to change, but it looks like it is ignored
#meta_kernels.add_new_edge_kernel('xenial', ['linux-azure-edge'], '-4.11.0')   # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('xenial', ['linux-gcp'], '-4.8.0')  # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('xenial', ['linux-gke'], '-4.4.0', signed=False)
meta_kernels.add_new_kernel('xenial', ['linux-kvm'], '-4.4.0', signed=False)
meta_kernels.add_new_kernel('xenial', ['linux-oem'], '-4.13.0')
meta_kernels.add_new_kernel('xenial', ['linux-oracle'], '-4.15.0')
meta_kernels.add_new_kernel('xenial', ['linux-snapdragon'], '-4.4.0', signed=False)
meta_kernels.add_new_kernel('xenial', ['linux-hwe'], '-4.8.0')
meta_kernels.add_new_edge_kernel('xenial', ['linux-hwe-edge'], '-4.8.0')
meta_kernels.add_new_kernel('esm-infra/xenial', ['linux'], '-4.4.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/xenial', ['linux-aws'], '-4.4.0', signed=False, ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/xenial', ['linux-aws-hwe'], '-4.15.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/xenial', ['linux-azure'], '-4.15.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/xenial', ['linux-gcp'], '-4.15.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/xenial', ['linux-hwe'], '-4.15.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/xenial', ['linux-kvm'], '-4.4.0', signed=False, ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/xenial', ['linux-oracle'], '-4.15.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('fips/xenial', ['linux-fips'], '-4.4.0', signed=False, ppa='ubuntu-advantage/fips')
meta_kernels.add_new_kernel('fips-updates/xenial', ['linux-fips'], '-4.4.0', ppa='ubuntu-advantage/pro-fips-updates')
meta_kernels.add_new_kernel('bionic', ['linux'], '-4.15.0')
meta_kernels.add_new_kernel('bionic', ['linux-raspi2'], '-4.15.0', signed=False)
meta_kernels.add_new_kernel('bionic', ['linux-raspi2-5.3'], '-5.3.0', signed=False)
meta_kernels.add_new_kernel('bionic', ['linux-raspi-5.4'], '-5.4.0', signed=False)
meta_kernels.add_new_kernel('bionic', ['linux-snapdragon'], '-4.15.0', signed=False)
meta_kernels.add_new_kernel('bionic', ['linux-oem'], '-4.15.0')
meta_kernels.add_new_kernel('bionic', ['linux-oem-osp1'], '-5.0.0')
meta_kernels.add_new_kernel('bionic', ['linux-aws'], '-4.15.0')
meta_kernels.add_new_kernel('bionic', ['linux-aws-5.0'], '-5.0.0', signed=False)
meta_kernels.add_new_kernel('bionic', ['linux-aws-5.3'], '-5.3.0', signed=False)
meta_kernels.add_new_kernel('bionic', ['linux-aws-5.4'], '-5.4.0')
meta_kernels.add_new_edge_kernel('bionic', ['linux-aws-edge'], '-4.18.0', signed=False)
meta_kernels.add_new_kernel('bionic', ['linux-azure'], '-4.15.0')   # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('bionic', ['linux-azure-4.15'], '-4.15.0')
meta_kernels.add_new_kernel('bionic', ['linux-azure-5.3'], '-5.3.0')
meta_kernels.add_new_kernel('bionic', ['linux-azure-5.4'], '-5.4.0')
meta_kernels.add_new_edge_kernel('bionic', ['linux-azure-edge'], '-4.18.0')   # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('bionic', ['linux-gcp'], '-4.15.0')  # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_edge_kernel('bionic', ['linux-gcp-edge'], '-4.15.0')  # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('bionic', ['linux-dell300x'], '-4.15.0')
meta_kernels.add_new_kernel('bionic', ['linux-gcp-4.15'], '-4.15.0')  # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('bionic', ['linux-gcp-5.3'], '-5.3.0')
meta_kernels.add_new_kernel('bionic', ['linux-gcp-5.4'], '-5.4.0')
meta_kernels.add_new_kernel('bionic', ['linux-gke-4.15'], '-4.15.0')
meta_kernels.add_new_kernel('bionic', ['linux-gke-5.0'], '-5.0')
meta_kernels.add_new_kernel('bionic', ['linux-gke-5.3'], '-5.3')
meta_kernels.add_new_kernel('bionic', ['linux-gke-5.4'], '-5.4.0')
meta_kernels.add_new_kernel('bionic', ['linux-gkeop-5.4'], '-5.4.0')
meta_kernels.add_new_kernel('bionic', ['linux-kvm'], '-4.15.0', signed=False)
meta_kernels.add_new_kernel('bionic', ['linux-oracle'], '-4.15.0')
meta_kernels.add_new_kernel('bionic', ['linux-oracle-5.0'], '-5.0.0')
meta_kernels.add_new_kernel('bionic', ['linux-oracle-5.3'], '-5.3.0')
meta_kernels.add_new_kernel('bionic', ['linux-oracle-5.4'], '-5.4.0')
meta_kernels.add_new_kernel('bionic', ['linux-hwe'], '-4.18.0')
meta_kernels.add_new_kernel('bionic', ['linux-hwe-5.4'], '-5.4.0')
meta_kernels.add_new_edge_kernel('bionic', ['linux-hwe-edge'], '-4.18.0')
meta_kernels.add_new_kernel('bionic', ['linux-ibm-5.4'], '-5.4.0')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux'], '-4.15.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux-aws'], '-4.15.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux-azure-4.15'], '-4.15.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux-dell300x'], '-4.15.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux-gcp-4.15'], '-4.15.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux-kvm'], '-4.15.0', signed=False ,ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux-oracle'], '-4.15.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux-raspi2'], '-4.15.0', signed=False, ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux-snapdragon'], '-4.15.0', signed=False, ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux-hwe-5.4'], '-5.4.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux-aws-5.4'], '-5.4.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux-azure-5.4'], '-5.4.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux-gcp-5.4'], '-5.4.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux-ibm-5.4'], '-5.4.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux-oracle-5.4'], '-5.4.0', ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('esm-infra/bionic', ['linux-raspi-5.4'], '-5.4.0', signed=False, ppa='ubuntu-esm/esm-infra-security')
meta_kernels.add_new_kernel('fips/bionic', ['linux-fips'], '-4.15.0', ppa='ubuntu-advantage/fips')
meta_kernels.add_new_kernel('fips/bionic', ['linux-aws-fips'], '-4.15.0', ppa='ubuntu-advantage/fips')
meta_kernels.add_new_kernel('fips/bionic', ['linux-azure-fips'], '-4.15.0', ppa='ubuntu-advantage/fips')
meta_kernels.add_new_kernel('fips/bionic', ['linux-gcp-fips'], '-4.15.0', ppa='ubuntu-advantage/fips')
meta_kernels.add_new_kernel('fips-updates/bionic', ['linux-fips'], '-4.15.0', ppa='ubuntu-advantage/pro-fips-updates')
meta_kernels.add_new_kernel('fips-updates/bionic', ['linux-aws-fips'], '-4.15.0', ppa='ubuntu-advantage/pro-fips-updates')
meta_kernels.add_new_kernel('fips-updates/bionic', ['linux-azure-fips'], '-4.15.0', ppa='ubuntu-advantage/pro-fips-updates')
meta_kernels.add_new_kernel('fips-updates/bionic', ['linux-gcp-fips'], '-4.15.0', ppa='ubuntu-advantage/pro-fips-updates')
meta_kernels.add_new_kernel('focal', ['linux'], '-5.4.0')
meta_kernels.add_new_kernel('focal', ['linux-raspi'], '-5.4.0', signed=False)
meta_kernels.add_new_kernel('focal', ['linux-raspi2'], '-5.4.0', signed=False)
meta_kernels.add_new_kernel('focal', ['linux-oem-5.6'], '-5.6.0')
meta_kernels.add_new_kernel('focal', ['linux-oem-5.10'], '-5.10.0')
meta_kernels.add_new_kernel('focal', ['linux-oem-5.13'], '-5.13.0')
meta_kernels.add_new_kernel('focal', ['linux-oem-5.14'], '-5.14.0')
meta_kernels.add_new_kernel('focal', ['linux-aws'], '-5.4.0')
meta_kernels.add_new_kernel('focal', ['linux-aws-5.8'], '-5.8.0', signed=False)
meta_kernels.add_new_kernel('focal', ['linux-aws-5.11'], '-5.11.0', signed=False)
meta_kernels.add_new_kernel('focal', ['linux-aws-5.13'], '-5.13.0')
meta_kernels.add_new_kernel('focal', ['linux-aws-5.15'], '-5.15.0')
meta_kernels.add_new_kernel('focal', ['linux-azure'], '-5.4.0')   # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('focal', ['linux-azure-5.8'], '-5.8.0')   # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('focal', ['linux-azure-5.11'], '-5.11.0')   # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('focal', ['linux-azure-5.13'], '-5.13.0')   # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('focal', ['linux-azure-5.15'], '-5.15.0')   # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('focal', ['linux-bluefield'], '-5.4.0')
meta_kernels.add_new_kernel('focal', ['linux-azure-fde'], '-5.4.0')   # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('focal', ['linux-gcp'], '-5.4.0')  # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('focal', ['linux-gcp-5.8'], '-5.8.0')  # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('focal', ['linux-gcp-5.11'], '-5.11.0')  # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('focal', ['linux-gcp-5.13'], '-5.13.0')  # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('focal', ['linux-gcp-5.15'], '-5.15.0')  # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('focal', ['linux-gke'], '-5.4.0')
meta_kernels.add_new_kernel('focal', ['linux-gke-5.15'], '-5.15.0')
meta_kernels.add_new_kernel('focal', ['linux-gkeop-5.15'], '-5.15.0')
meta_kernels.add_new_kernel('focal', ['linux-gkeop'], '-5.4.0')
meta_kernels.add_new_kernel('focal', ['linux-ibm'], '-5.4.0')
meta_kernels.add_new_kernel('focal', ['linux-ibm-5.15'], '-5.15.0')
meta_kernels.add_new_kernel('focal', ['linux-intel-5.13'], '-5.13.0')
meta_kernels.add_new_kernel('focal', ['linux-intel-iotg-5.15'], '-5.15.0')
meta_kernels.add_new_kernel('focal', ['linux-iot'], '-5.4.0')
meta_kernels.add_new_kernel('focal', ['linux-kvm'], '-5.4.0')
meta_kernels.add_new_kernel('focal', ['linux-oracle'], '-5.4')
meta_kernels.add_new_kernel('focal', ['linux-oracle-5.8'], '-5.8')
meta_kernels.add_new_kernel('focal', ['linux-oracle-5.11'], '-5.11')
meta_kernels.add_new_kernel('focal', ['linux-oracle-5.13'], '-5.13')
meta_kernels.add_new_kernel('focal', ['linux-oracle-5.15'], '-5.15')
meta_kernels.add_new_kernel('focal', ['linux-riscv'], '-5.4', signed=False)
meta_kernels.add_new_kernel('focal', ['linux-riscv-5.8'], '-5.8', signed=False)
meta_kernels.add_new_kernel('focal', ['linux-riscv-5.11'], '-5.8', signed=False)
meta_kernels.add_new_kernel('focal', ['linux-riscv-5.15'], '-5.15.0', signed=False)
meta_kernels.add_new_kernel('focal', ['linux-hwe-5.8'], '-5.8.0')
meta_kernels.add_new_kernel('focal', ['linux-hwe-5.11'], '-5.11.0')
meta_kernels.add_new_kernel('focal', ['linux-hwe-5.13'], '-5.13.0')
meta_kernels.add_new_kernel('focal', ['linux-hwe-5.15'], '-5.15.0')
meta_kernels.add_new_kernel('focal', ['linux-lowlatency-hwe-5.15'], '-5.15.0')
meta_kernels.add_new_kernel('focal', ['linux-azure-fde-5.15'], '-5.15.0')
meta_kernels.add_new_kernel('focal', ['linux-xilinx-zynqmp'], '-5.4.0', signed=False)
meta_kernels.add_new_kernel('fips/focal', ['linux-fips'], '-5.4.0', ppa='ubuntu-advantage/fips')
meta_kernels.add_new_kernel('fips/focal', ['linux-aws-fips'], '-5.4.0', ppa='ubuntu-advantage/fips')
meta_kernels.add_new_kernel('fips/focal', ['linux-azure-fips'], '-5.4.0', ppa='ubuntu-advantage/fips')
meta_kernels.add_new_kernel('fips/focal', ['linux-gcp-fips'], '-5.4.0', ppa='ubuntu-advantage/fips')
meta_kernels.add_new_kernel('fips-updates/focal', ['linux-fips'], '-5.4.0', ppa='ubuntu-advantage/pro-fips-updates')
meta_kernels.add_new_kernel('fips-updates/focal', ['linux-aws-fips'], '-5.4.0', ppa='ubuntu-advantage/pro-fips-updates')
meta_kernels.add_new_kernel('fips-updates/focal', ['linux-azure-fips'], '-5.4.0', ppa='ubuntu-advantage/pro-fips-updates')
meta_kernels.add_new_kernel('fips-updates/focal', ['linux-gcp-fips'], '-5.4.0', ppa='ubuntu-advantage/pro-fips-updates')
meta_kernels.add_new_kernel('groovy', ['linux'], '-5.8.0')
meta_kernels.add_new_kernel('groovy', ['linux-raspi'], '-5.8.0', signed=False)
meta_kernels.add_new_kernel('groovy', ['linux-aws'], '-5.8.0', signed=False)
meta_kernels.add_new_kernel('groovy', ['linux-azure'], '-5.8.0')   # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('groovy', ['linux-gcp'], '-5.8.0')  # suffix may need to change, but it looks like it is ignored
meta_kernels.add_new_kernel('groovy', ['linux-kvm'], '-5.8.0')
meta_kernels.add_new_kernel('groovy', ['linux-oracle'], '-5.8')
meta_kernels.add_new_kernel('groovy', ['linux-riscv'], '-5.8', signed=False)
meta_kernels.add_new_kernel('hirsute', ['linux'], '-5.11.0')
meta_kernels.add_new_kernel('hirsute', ['linux-raspi'], '-5.11.0', signed=False)
meta_kernels.add_new_kernel('hirsute', ['linux-aws'], '-5.11.0', signed=False)
meta_kernels.add_new_kernel('hirsute', ['linux-azure'], '-5.11.0')
meta_kernels.add_new_kernel('hirsute', ['linux-gcp'], '-5.11.0')
meta_kernels.add_new_kernel('hirsute', ['linux-kvm'], '-5.11.0')
meta_kernels.add_new_kernel('hirsute', ['linux-oracle'], '-5.11')
meta_kernels.add_new_kernel('hirsute', ['linux-riscv'], '-5.11', signed=False)
meta_kernels.add_new_kernel('impish', ['linux'], '-5.13.0')
meta_kernels.add_new_kernel('impish', ['linux-raspi'], '-5.13.0', signed=False)
meta_kernels.add_new_kernel('impish', ['linux-aws'], '-5.13.0')
meta_kernels.add_new_kernel('impish', ['linux-azure'], '-5.13.0')
meta_kernels.add_new_kernel('impish', ['linux-gcp'], '-5.13.0')
meta_kernels.add_new_kernel('impish', ['linux-kvm'], '-5.13.0')
meta_kernels.add_new_kernel('impish', ['linux-oracle'], '-5.13')
meta_kernels.add_new_kernel('impish', ['linux-riscv'], '-5.13', signed=False)
meta_kernels.add_new_kernel('jammy', ['linux'], '-5.15.0')
meta_kernels.add_new_kernel('jammy', ['linux-raspi'], '-5.15.0', signed=False)
meta_kernels.add_new_kernel('jammy', ['linux-allwinner-5.19'], '-5.19.0', signed=False)
meta_kernels.add_new_kernel('jammy', ['linux-aws'], '-5.15.0')
meta_kernels.add_new_kernel('jammy', ['linux-aws-5.19'], '-5.19.0')
meta_kernels.add_new_kernel('jammy', ['linux-aws-6.2'], '-6.2.0')
meta_kernels.add_new_kernel('jammy', ['linux-aws-6.5'], '-6.5.0')
meta_kernels.add_new_kernel('jammy', ['linux-aws-6.8'], '-6.8.0')
meta_kernels.add_new_kernel('jammy', ['linux-azure'], '-5.15.0')
# the linux-azure-5.19 never left edge status
# meta_kernels.add_new_kernel('jammy', ['linux-azure-5.19'], '-5.19.0')
meta_kernels.add_new_kernel('jammy', ['linux-azure-6.2'], '-6.2.0')
meta_kernels.add_new_kernel('jammy', ['linux-azure-6.5'], '-6.5.0')
meta_kernels.add_new_kernel('jammy', ['linux-azure-6.8'], '-6.8.0')
meta_kernels.add_new_kernel('jammy', ['linux-azure-fde'], '-5.15.0')
# the linux-azure-fde-5.19 never left edge status
# meta_kernels.add_new_kernel('jammy', ['linux-azure-fde-5.19'], '-5.19.0')
meta_kernels.add_new_kernel('jammy', ['linux-azure-fde-6.2'], '-6.2.0')
meta_kernels.add_new_kernel('jammy', ['linux-gcp'], '-5.15.0')
meta_kernels.add_new_kernel('jammy', ['linux-gcp-5.19'], '-5.19.0')
meta_kernels.add_new_kernel('jammy', ['linux-gcp-6.2'], '-6.2.0')
meta_kernels.add_new_kernel('jammy', ['linux-gcp-6.5'], '-6.5.0')
meta_kernels.add_new_kernel('jammy', ['linux-gcp-6.8'], '-6.8.0')
meta_kernels.add_new_kernel('jammy', ['linux-gke'], '-5.15.0')
meta_kernels.add_new_kernel('jammy', ['linux-gkeop'], '-5.15.0')
meta_kernels.add_new_kernel('jammy', ['linux-hwe-5.19'], '-5.19.0')
meta_kernels.add_new_kernel('jammy', ['linux-hwe-6.2'], '-6.2.0')
meta_kernels.add_new_kernel('jammy', ['linux-hwe-6.5'], '-6.5.0')
meta_kernels.add_new_kernel('jammy', ['linux-hwe-6.8'], '-6.8.0')
meta_kernels.add_new_kernel('jammy', ['linux-ibm'], '-5.15.0')
meta_kernels.add_new_kernel('jammy', ['linux-intel-iotg'], '-5.15.0')
meta_kernels.add_new_kernel('jammy', ['linux-kvm'], '-5.15.0')
meta_kernels.add_new_kernel('jammy', ['linux-lowlatency'], '-5.15.0')
meta_kernels.add_new_kernel('jammy', ['linux-lowlatency-hwe-5.19'], '-5.19.0')
meta_kernels.add_new_kernel('jammy', ['linux-lowlatency-hwe-6.2'], '-6.2.0')
meta_kernels.add_new_kernel('jammy', ['linux-lowlatency-hwe-6.5'], '-6.5.0')
meta_kernels.add_new_kernel('jammy', ['linux-lowlatency-hwe-6.8'], '-6.8.0')
meta_kernels.add_new_kernel('jammy', ['linux-nvidia'], '-5.15.0')
meta_kernels.add_new_kernel('jammy', ['linux-nvidia-6.2'], '-6.2.0')
meta_kernels.add_new_kernel('jammy', ['linux-nvidia-6.5'], '-6.5.0')
meta_kernels.add_new_kernel('jammy', ['linux-nvidia-6.8'], '-6.8.0')
meta_kernels.add_new_kernel('jammy', ['linux-nvidia-tegra'], '-5.15.0')
meta_kernels.add_new_kernel('jammy', ['linux-nvidia-tegra-igx'], '-5.15.0')
meta_kernels.add_new_kernel('jammy', ['linux-oem-5.17'], '-5.17.0')
meta_kernels.add_new_kernel('jammy', ['linux-oem-6.0'], '-6.0.0')
meta_kernels.add_new_kernel('jammy', ['linux-oem-6.1'], '-6.1.0')
meta_kernels.add_new_kernel('jammy', ['linux-oem-6.5'], '-6.5.0')
meta_kernels.add_new_kernel('jammy', ['linux-oracle'], '-5.15')
meta_kernels.add_new_kernel('jammy', ['linux-oracle-6.5'], '-6.5')
meta_kernels.add_new_kernel('jammy', ['linux-oracle-6.8'], '-6.8.0')
meta_kernels.add_new_kernel('jammy', ['linux-riscv'], '-5.15', signed=False)
meta_kernels.add_new_kernel('jammy', ['linux-riscv-5.19'], '-5.19.0', signed=False)
meta_kernels.add_new_kernel('jammy', ['linux-riscv-6.5'], '-6.5.0', signed=False)
meta_kernels.add_new_kernel('jammy', ['linux-riscv-6.8'], '-6.8.0', signed=False)
meta_kernels.add_new_kernel('jammy', ['linux-starfive-5.19'], '-5.19.0', signed=False)
meta_kernels.add_new_kernel('jammy', ['linux-starfive-6.2'], '-6.2.0', signed=False)
meta_kernels.add_new_kernel('jammy', ['linux-starfive-6.5'], '-6.5.0', signed=False)
meta_kernels.add_new_kernel('jammy', ['linux-xilinx-zynqmp'], '-5.15.0', signed=False)
meta_kernels.add_new_kernel('bluefield/jammy', ['linux-bluefield'], '-5.15.0', ppa='canonical-kernel-bluefield/release')
meta_kernels.add_new_kernel('fips-updates/jammy', ['linux-fips'], '-5.15.0', ppa='ubuntu-advantage/pro-fips-updates')
meta_kernels.add_new_kernel('fips-updates/jammy', ['linux-aws-fips'], '-5.15.0', ppa='ubuntu-advantage/pro-fips-updates')
meta_kernels.add_new_kernel('fips-updates/jammy', ['linux-azure-fips'], '-5.15.0', ppa='ubuntu-advantage/pro-fips-updates')
meta_kernels.add_new_kernel('fips-updates/jammy', ['linux-gcp-fips'], '-5.15.0', ppa='ubuntu-advantage/pro-fips-updates')
meta_kernels.add_new_kernel('realtime/jammy', ['linux-realtime'], '-5.15.0', ppa='ubuntu-advantage/realtime-updates')
meta_kernels.add_new_kernel('realtime/jammy', ['linux-intel-iot-realtime'], '-5.15.0', ppa='ubuntu-advantage/realtime-updates')
meta_kernels.add_new_kernel('realtime/jammy', ['linux-realtime-6.8'], '-6.8.0', ppa='ubuntu-advantage/realtime-updates')
meta_kernels.add_new_kernel('kinetic', ['linux'], '-5.19.0')
meta_kernels.add_new_kernel('kinetic', ['linux-lowlatency'], '-5.19.0')
meta_kernels.add_new_kernel('kinetic', ['linux-raspi'], '-5.19.0', signed=False)
meta_kernels.add_new_kernel('kinetic', ['linux-allwinner'], '-5.19.0', signed=False)
meta_kernels.add_new_kernel('kinetic', ['linux-aws'], '-5.19.0')
meta_kernels.add_new_kernel('kinetic', ['linux-azure'], '-5.19.0')
meta_kernels.add_new_kernel('kinetic', ['linux-gcp'], '-5.19.0')
meta_kernels.add_new_kernel('kinetic', ['linux-ibm'], '-5.19.0')
meta_kernels.add_new_kernel('kinetic', ['linux-kvm'], '-5.19.0')
meta_kernels.add_new_kernel('kinetic', ['linux-oracle'], '-5.19')
meta_kernels.add_new_kernel('kinetic', ['linux-riscv'], '-5.19', signed=False)
meta_kernels.add_new_kernel('kinetic', ['linux-starfive'], '-5.19.0', signed=False)
meta_kernels.add_new_kernel('lunar', ['linux'], '-6.2.0')
meta_kernels.add_new_kernel('lunar', ['linux-lowlatency'], '-6.2.0')
meta_kernels.add_new_kernel('lunar', ['linux-raspi'], '-6.2.0', signed = False)
meta_kernels.add_new_kernel('lunar', ['linux-allwinner'], '-5.19.0', signed=False)
meta_kernels.add_new_kernel('lunar', ['linux-aws'], '-6.2.0')
meta_kernels.add_new_kernel('lunar', ['linux-azure'], '-6.2.0')
meta_kernels.add_new_kernel('lunar', ['linux-gcp'], '-6.2.0')
meta_kernels.add_new_kernel('lunar', ['linux-ibm'], '-6.2.0')
meta_kernels.add_new_kernel('lunar', ['linux-kvm'], '-6.2.0')
meta_kernels.add_new_kernel('lunar', ['linux-oracle'], '-6.2.0')
meta_kernels.add_new_kernel('lunar', ['linux-riscv'], '-6.2.0', signed = False)
meta_kernels.add_new_kernel('lunar', ['linux-starfive'], '-5.19.0', signed=False)
meta_kernels.add_new_kernel('mantic', ['linux'], '-6.5.0')
meta_kernels.add_new_kernel('mantic', ['linux-lowlatency'], '-6.5.0')
meta_kernels.add_new_kernel('mantic', ['linux-raspi'], '-6.5.0', signed = False)
meta_kernels.add_new_kernel('mantic', ['linux-aws'], '-6.5.0')
meta_kernels.add_new_kernel('mantic', ['linux-azure'], '-6.5.0')
meta_kernels.add_new_kernel('mantic', ['linux-gcp'], '-6.5.0')
meta_kernels.add_new_kernel('mantic', ['linux-ibm'], '-6.5.0')
meta_kernels.add_new_kernel('mantic', ['linux-oracle'], '-6.5.0')
meta_kernels.add_new_kernel('mantic', ['linux-riscv'], '-6.5.0', signed=False)
meta_kernels.add_new_kernel('mantic', ['linux-starfive'], '-6.5.0', signed=False)
meta_kernels.add_new_kernel('mantic', ['linux-laptop'], '-6.5.0', signed=False)  # ARM for lenovo x13s laptops
meta_kernels.add_new_kernel('noble', ['linux'], '-6.8.0')
meta_kernels.add_new_kernel('noble', ['linux-lowlatency'], '-6.8.0')
meta_kernels.add_new_kernel('noble', ['linux-raspi'], '-6.8.0', signed = False)
# need to sort out USN publishing story for these kernels
# meta_kernels.add_new_kernel('noble', ['linux-fips'], '-6.8.0')
# meta_kernels.add_new_kernel('noble', ['linux-ibm-gt'], '-6.8.0')
# meta_kernels.add_new_kernel('noble', ['linux-xilinx'], '-6.8.0')
meta_kernels.add_new_kernel('noble', ['linux-aws'], '-6.8.0')
meta_kernels.add_new_kernel('noble', ['linux-azure'], '-6.8.0')
meta_kernels.add_new_kernel('noble', ['linux-gcp'], '-6.8.0')
meta_kernels.add_new_kernel('noble', ['linux-gke'], '-6.8.0')
meta_kernels.add_new_kernel('noble', ['linux-gkeop'], '-6.8.0')
meta_kernels.add_new_kernel('noble', ['linux-hwe-6.11'], '-6.11.0')
meta_kernels.add_new_kernel('noble', ['linux-ibm'], '-6.8.0')
meta_kernels.add_new_kernel('noble', ['linux-intel'], '-6.8.0')
meta_kernels.add_new_kernel('noble', ['linux-lowlatency-hwe-6.11'], '-6.11.0')
meta_kernels.add_new_kernel('noble', ['linux-oem-6.8'], '-6.8.0')
meta_kernels.add_new_kernel('noble', ['linux-oem-6.11'], '-6.11.0')
meta_kernels.add_new_kernel('noble', ['linux-oracle'], '-6.8.0')
meta_kernels.add_new_kernel('noble', ['linux-nvidia'], '-6.8.0')
meta_kernels.add_new_kernel('noble', ['linux-nvidia-lowlatency'], '-6.8.0')
# a devel kernel not ready for USNs, uncomment when this gets in the SRU cycles
# meta_kernels.add_new_kernel('noble', ['linux-nvidia-tegra'], '-6.8.0')
meta_kernels.add_new_kernel('noble', ['linux-riscv'], '-6.8.0', signed = False)
meta_kernels.add_new_kernel('realtime/noble', ['linux-realtime'], '-6.8.0', ppa='ubuntu-advantage/realtime-updates')
meta_kernels.add_new_kernel('realtime/noble', ['linux-raspi-realtime'], '-6.8.0', signed = False, ppa='ubuntu-advantage/realtime-updates')
meta_kernels.add_new_kernel('oracular', ['linux'], '-6.11.0')
meta_kernels.add_new_kernel('oracular', ['linux-lowlatency'], '-6.11.0')
meta_kernels.add_new_kernel('oracular', ['linux-raspi'], '-6.11.0', signed = False)
meta_kernels.add_new_kernel('oracular', ['linux-aws'], '-6.11.0')
meta_kernels.add_new_kernel('oracular', ['linux-azure'], '-6.11.0')
meta_kernels.add_new_kernel('oracular', ['linux-gcp'], '-6.11.0')
meta_kernels.add_new_kernel('oracular', ['linux-oracle'], '-6.11.0')
meta_kernels.add_new_kernel('oracular', ['linux-realtime'], '-6.11.0')
meta_kernels.add_new_kernel('oracular', ['linux-riscv'], '-6.11.0', signed = False)

# list of kernel versions to masquerade as when things end up in the
# wrong pockets or otherwise should not have a USN published for it.
# Data structure format:
#   '$KERNEL':
#       "$RELEASE": {
#           'LAST USN VERSION': 'CURRENT VERSION IN SECURITY'
#       }
#   }
#
kernel_glitches = {
    'linux': {
        'maverick': {
            '2.6.35-28.49': '2.6.35-28.50'
        },
        'precise': {
            '3.2.0-105.146': '3.2.0-106.147'
        },
        'trusty': {
            '3.13.0-49.81': '3.13.0-49.83',
            '3.13.0-166.216': '3.13.0-167.217',
        },
        'utopic': {
            '~': '3.16.0-44.59'
        },
        'xenial': {
            '4.4.0-28.47': '4.4.0-31.50',
            '4.4.0-210.242': '4.4.0-211.243',  # Bugfix only update
            '4.4.0-216.249': '4.4.0-217.250',  # LP: #1939915
        },
        'zesty': {
            '~': '4.10.0-20.22'
        },
        'artful': {  # artful update to disable spi driver
            '4.13.0-19.22': '4.13.0-21.24'
        },
        'bionic': {  # bionic: LP: #1938013
            '4.15.0-151.157': '4.15.0-153.160',
            '4.15.0-194.205': '4.15.0-196.207', # LP: #1994601
        },
        'disco': {  # disco i386 PTI regression fix
            '5.0.0-21.22': '5.0.0-23.24',
        },
        'focal': {
            '5.4.0-28.32': '5.4.0-29.33',  # signed nvidia modules regression fix (LP: #1875888)
        },
        'oracular': {
            '~': '6.11.0-12.13', # first non dev in -security
        },
    },
    'linux-allwinner': {
        'kinetic': {
            '~': '5.19.0-1014.14',  # initial publication
        },
    },
    'linux-allwinner-5.19': {
        'jammy': {
            '~': '5.19.0-1014.14~22.04.1',  # initial publication
        },
    },
    'linux-aws': {  # linux-aws
        'trusty': {
            '4.4.0-1009.9': '4.4.0-1010.10',
            '4.4.0-1092.96': '4.4.0-1093.97',
            '4.4.0-1096.101': '4.4.0-1097.102',  # LP: #1939915
            '4.4.0-1103.108': '4.4.0-1104.109',
        },
        'xenial': {
            '5.4.0-1047.56': '4.4.0-1048.57',
            '4.4.0-1128.142': '4.4.0-1129.143',
            '4.4.0-1132.146': '4.4.0-1133.147',  # LP: #1939915
        },
        'bionic': {
            '4.15.0-1033.35': '4.15.0-1034.36',
            '4.15.0-1086.91': '4.15.0-1087.92',
            '4.15.0-1099.106': '4.15.0-1101.108',
        },
        'cosmic': {
            '4.18.0-1008.10': '4.18.0-1011.13',
        },
        'focal': {
            '5.4.0-1020.20': '5.4.0-1021.21',
            '5.4.0-1028.29': '5.4.0-1029.30',
            '5.4.0-1045.47': '5.4.0-1047.49',
        },
        'oracular': {
            '~': '6.11.0-1006.6', # first non dev in -security
        },
    },
    'linux-aws-5.0': {  # linux-aws
        'bionic': {
            '~': '5.0.0-1021.24~18.04.1',  # initial publication
        },
    },
    'linux-aws-5.3': {  # linux-aws
        'bionic': {
            '~': '5.3.0-1017.18~18.04.1',  # initial publication
        },
    },
    'linux-aws-5.4': {  # linux-aws
        'bionic': {
            '5.4.0-1028.29~18.04.1': '5.4.0-1029.30~18.04.1',  # initial publication
            '5.4.0-1045.47~18.04.1': '5.4.0-1047.49~18.04.1',  # initial publication
        },
    },
    'linux-aws-5.8': {  # linux-aws
        'focal': {
            '~': '5.8.0-1035.37~20.04.1',  # initial publication
        },
    },
    'linux-aws-5.11': {  # linux-aws
        'focal': {
            '~': '5.11.0-1016.17~20.04.1',  # initial publication
        },
    },
    'linux-aws-5.13': {  # linux-aws
        'focal': {
            '~': '5.13.0-1011.12~20.04.1',  # initial publication
            '5.13.0-1028.31~20.04.1': '5.13.0-1029.32~20.04.1',  # LP: #1973620 fix
        },
    },
    'linux-aws-5.15': {  # linux-aws
        'focal': {
            '~': '5.15.0-1015.19~20.04.1',  # initial publication
        },
    },
    'linux-aws-5.19': {  # linux-aws
        'jammy': {
            '~': '5.19.0-1027.28~22.04.1',  # initial publication
        },
    },
    'linux-aws-6.2': {  # linux-aws
        'jammy': {
            '~': '6.2.0-1009.9~22.04.3',  # initial publication
        },
    },
    'linux-aws-6.5': {
        'jammy': {
            '~': '6.5.0-1014.14~22.04.1',  # initial publication
        },
    },
    'linux-aws-6.8': {
        'jammy': {
            '~': '6.8.0-1015.16~22.04.1',  # first non edge publication
        },
    },
    'linux-aws-fips': {
        'bionic': {
            '~': '4.15.0-2115.121',
            '4.15.0-2115.121': '4.15.0-2116.122', # not ready for USNs
        },
        'focal': {
            '~': '5.4.0-1137.147+fips1',
            '5.4.0-1137.147+fips1': '5.4.0-1139.149+fips1', # not ready for USNs
            '5.4.0-1139.149+fips1': '5.4.0-1140.151+fips1', # not ready for USNs
        },
        'jammy': {
            '~': '5.15.0-1077.84+fips1',
            '5.15.0-1077.84+fips1': '5.15.0-1079.86+fips1', # not ready for USNs
        },
    },
    'linux-aws-hwe': {  # linux-aws-hwe
        'xenial': {
            '4.15.0-1035.37~16.04.1': '4.15.0-1039.41~16.04.1',
            '4.15.0-1043.45~16.04.1': '4.15.0-1044.46~16.04.1',
        },
    },
    'linux-azure': {
        'trusty': {
            '4.15.0-1037.39~14.04.2': '4.15.0-1039.41~14.04.2',
            '4.15.0-1063.68~14.04.1': '4.15.0-1064.69~14.04.1',
        },
        'xenial': {
            '4.15.0-1037.39~16.04.1': '4.15.0-1039.43',
            '4.15.0-1045.49': '4.15.0-1046.50',
            '4.15.0-1047.51': '4.15.0-1049.54',
            '4.15.0-1049.54': '4.15.0-1050.55',
            '4.15.0-1050.55': '4.15.0-1051.56',
            '4.15.0-1051.56': '4.15.0-1052.57',
            '4.15.0-1063.68': '4.15.0-1064.69',
            '4.15.0-1066.71': '4.15.0-1067.72',
            '4.15.0-1067.72': '4.15.0-1069.74',
            '4.15.0-1113.126~16.04.1': '4.15.0-1114.127~16.04.1',
        },
        'bionic': {
            '4.15.0-1037.39': '4.18.0-1011.11~18.04.1',
            '4.18.0-1018.18~18.04.1': '4.18.0-1019.19~18.04.1',
            '4.18.0-1023.24~18.04.1': '4.18.0-1024.25~18.04.1',
            '4.18.0-1024.25~18.04.1': '4.18.0-1025.27~18.04.1',
            '5.0.0-1014.14~18.04.1': '5.0.0-1016.17~18.04.1',
            '5.0.0-1020.21~18.04.1': '5.0.0-1022.23~18.04.1',
            '5.0.0-1025.27~18.04.1': '5.0.0-1027.29~18.04.1',
            '5.0.0-1028.30~18.04.1': '5.0.0-1029.31~18.04.1',
            '5.0.0-1029.31~18.04.1': '5.0.0-1031.33',
        },
        'cosmic': {
            '4.18.0-1008.8': '4.18.0-1011.11',
            '4.18.0-1018.18': '4.18.0-1019.19',
            '4.18.0-1023.24': '4.18.0-1024.25',
        },
        'disco': {
            '5.0.0-1006.6': '5.0.0-1008.8',
            '5.0.0-1010.10': '5.0.0-1011.11',
            '5.0.0-1014.14': '5.0.0-1016.17',
            '5.0.0-1025.27': '5.0.0-1027.29',
        },
        'eoan': {
            '5.3.0-1007.8': '5.3.0-1008.9',
            '5.3.0-1009.10': '5.3.0-1010.11',
            '5.3.0-1010.11': '5.3.0-1012.13',
        },
        'jammy': {
            '5.15.0-1023.29': '5.15.0-1024.30', # no security fixes
        },
    },
    'linux-azure-4.15': {
        'bionic': {
            '~': '4.15.0-1082.92',  # initial publication
        },
    },
    'linux-azure-5.3': {
        'bionic': {
            '~': '5.3.0-1007.8~18.04.1',  # initial publication
            '5.3.0-1007.8~18.04.1': '5.3.0-1008.9~18.04.1',
            '5.3.0-1009.10~18.04.1': '5.3.0-1010.11~18.04.1',
            '5.3.0-1010.11~18.04.1': '5.3.0-1012.13~18.04.1',
        },
    },
    'linux-azure-5.4': {
        'bionic': {
            '~': '5.4.0-1020.20~18.04.1',  # initial publication
        },
    },
    'linux-azure-5.8': {
        'focal': {
            '~': '5.8.0-1033.35~20.04.1',  # initial publication
        },
    },
    'linux-azure-5.11': {
        'focal': {
            '~': '5.11.0-1013.14~20.04.1',  # initial publication
        },
    },
    'linux-azure-5.13': {
        'focal': {
            '5.13.0-1028.33~20.04.1': '5.13.0-1029.34~20.04.1',  # LP: #1973620 fix
        },
    },
    'linux-azure-5.15': {
        'focal': {
            '~': '5.15.0-1014.17~20.04.1',  # initial publication
        },
    },
    'linux-azure-6.2': {
        'jammy': {
            '~': '6.2.0-1011.11~22.04.1',  # initial non-edge publication
        },
    },
    'linux-azure-6.5': {
        'jammy': {
            '~': '6.5.0-1015.15~22.04.1',  # initial non-edge publication
        },
    },
    'linux-azure-6.8': {
        'jammy': {
            '~': '6.8.0-1015.17~22.04.2',
        },
    },
    'linux-azure-fde': {
        'focal': {
            '~': '5.4.0-1069.72+cvm1.1',  # initial publication
            '5.4.0-1085.90+cvm1.1': '5.4.0-1085.90+cvm2.1',  # fix for LP: #1980023
        },
        'jammy': {
            '~': '5.15.0-1019.24.1',  # initial publication
            '5.15.0-1073.82.1': '5.15.0-1078.87.1', # no cves reported in UCT
            '5.15.0-1082.91.1': '5.15.0-1084.93.1', # no cves reported in UCT
        },
    },
    'linux-azure-fde-5.15' : {
        'focal': {
            '~': '5.15.0-1036.43~20.04.1.1',
            '5.15.0-1074.83~20.04.1.1': '5.15.0-1078.87~20.04.1.1', # no cves reported in UCT
        },
    },
    'linux-azure-fde-6.2' : {
        'jammy': {
            '~': '6.2.0-1011.11~22.04.1.1', # initial non-edge publication
        },
    },
    'linux-azure-fips': {
        'bionic': {
            '~': '4.15.0-2094.100',
            '4.15.0-2094.100': '4.15.0-2095.101', # not ready for USNs
        },
        'focal': {
            '~': '5.4.0-1143.150+fips1',
            '5.4.0-1143.150+fips1': '5.4.0-1145.152+fips1', # not ready for USNs
        },
        'jammy': {
            '~': '5.15.0-1079.88+fips1',
            '5.15.0-1079.88+fips1': '5.15.0-1082.91+fips1', # not ready for USNs
        },
    },
    'linux-bluefield': {
        'focal': {
            '~': '5.4.0-1016.19',  # initial publication
            '5.4.0-1016.19': '5.4.0-1019.22',
            '5.4.0-1032.35': '5.4.0-1035.38',
            '5.4.0-1036.39': '5.4.0-1040.44',
        },
        'jammy': {
            '~': '5.15.0-1059.61',
            '5.15.0-1059.61': '5.15.0-1061.63', # not ready for USNs
            '5.15.0-1061.63': '5.15.0-1062.64', # not ready for USNs
            '5.15.0-1062.64': '5.15.0-1063.65', # not ready for USNs
        },
    },
    'linux-euclid': {
        'xenial': {
            '4.4.0-9027.29': '4.4.0-9028.30'
        },
    },
    'linux-dell300x': {
        'bionic': {
            '~': '4.15.0-1011.15',  # initial publication
        },
    },
    'linux-fips': {
        'xenial': {
            '~': '4.4.0-1108.115',
            '4.4.0-1108.115': '4.4.0-1109.116', # not ready for USNs
            '4.4.0-1109.116': '4.4.0-1111.118', # not ready for USNs
        },
        'bionic': {
            '~': '4.15.0-1131.142',
            '4.15.0-1131.142': '4.15.0-1133.144', # not ready for USNs
        },
        'focal': {
            '~': '5.4.0-1112.122',
        },
        'jammy' :{
            '~': '5.15.0-131.141+fips1',
            '5.15.0-131.141+fips1': '5.15.0-134.145+fips1', # not ready for USNs
        },
    },
    'linux-gcp': {  # linux-gcp
        'xenial': {
            '~': '4.10.0-1006.6',  # initial publication
            '4.15.0-1032.34~16.04.1': '4.15.0-1033.35~16.04.1',
            '4.15.0-1044.46': '4.15.0-1046.49',
        },
        'bionic': {
            '4.15.0-1040.42': '4.15.0-1042.45',
            '4.15.0-1044.70': '5.0.0-1020.20~18.04.1',
            '5.0.0-1026.27~18.04.1': '5.0.0-1028.29~18.04.1',
        },
        'oracular': {
            '~': '6.11.0-1005.5', # first non dev in -security
        },
    },
    'linux-gcp-4.15': {  # linux-gcp
        'bionic': {
            '~': '4.15.0-1077.87',  # initial publication
        },
    },
    'linux-gcp-5.3': {  # linux-gcp
        'bionic': {
            '~': '5.3.0-1008.9~18.04.1',  # initial publication
        },
    },
    'linux-gcp-5.8': {  # linux-gcp
        'focal': {
            '~': '5.8.0-1032.34~20.04.1',  # initial publication
        },
    },
    'linux-gcp-5.11': {  # linux-gcp
        'focal': {
            '~': '5.11.0-1020.22~20.04.1',  # initial publication
        },
    },
    'linux-gcp-5.13': {  # linux-gcp
        'focal': {
            '~': '5.13.0-1013.16~20.04.1',  # initial publication
            '5.13.0-1030.36~20.04.1': '5.13.0-1031.37~20.04.1',  # LP: #1973620 fix
        },
    },
    'linux-gcp-5.15': {  # linux-gcp
        'focal': {
            '~': '5.15.0-1013.18~20.04.1',  # initial publication
        },
    },
    'linux-gcp-5.19': {  # linux-gcp
        'jammy': {
            '~': '5.19.0-1026.28~22.04.1',  # initial publication
        },
    },
    'linux-gcp-6.2': {  # linux-gcp
        'jammy': {
            '~': '6.2.0-1012.12~22.04.1',  # initial publication
        },
    },
    'linux-gcp-6.5': {
        'jammy': {
            '~': '6.5.0-1014.14~22.04.1',  # initial publication
        },
    },
    'linux-gcp-6.8': {
        'jammy': {
            '~': '6.8.0-1015.17~22.04.1',
        },
    },
    'linux-gcp-fips': {
        'bionic': {
            '~': '4.15.0-2078.84',
            '4.15.0-2078.84': '4.15.0-2079.85', # not ready for USNs
        },
        'focal': {
            '~': '5.4.0-1142.151+fips1',
            '5.4.0-1142.151+fips1': '5.4.0-1143.152+fips1', # not ready for USNs
        },
        'jammy': {
            '~': '5.15.0-1075.84+fips1',
            '5.15.0-1075.84+fips1': '5.15.0-1078.87+fips1', # not ready for USNs
        },
    },
    'linux-gke': {  # linux-gke
        'xenial': {
            '~': '4.4.0-1003.3'
        },
        'focal': {
            '~': '5.4.0-1042.44',
        },
    },
    'linux-gke-4.15': {  # linux-gke-4.15
        'bionic': {
            '~': '4.15.0-1034.36',
            '4.15.0-1036.38': '4.15.0-1037.39',
            '4.15.0-1044.46': '4.15.0-1045.48',
        },
    },
    'linux-gke-5.0': {
        'bionic': {
            '~': '5.0.0-1013.13~18.04.1',
            '5.0.0-1020.20~18.04.1': '5.0.0-1022.22~18.04.3',
            '5.0.0-1049.50': '5.0.0-1050.52',
        },
    },
    'linux-gke-5.3': {
        'bionic': {
            '~': '5.3.0-1012.13~18.04.1',
            '5.3.0-1016.17~18.04.1': '5.3.0-1017.18~18.04.1',
        },
    },
    'linux-gke-5.4': {
        'bionic': {
            '~': '5.4.0-1029.31~18.04.1',
            '5.4.0-1029.31~18.04.1': '5.4.0-1032.34~18.04.1',
            '5.4.0-1068.71~18.04.1': '5.4.0-1071.76~18.04.3',
        },
    },
    'linux-gke-5.15': {
        'focal': {
            '~': '5.15.0-1011.14~20.04.1', # initial publication
        },
    },
    'linux-gkeop': {
        'focal': {
            '~': '5.4.0-1009.10',
        },
        'jammy': {
            '~': '5.15.0-1001.2',  # Initial publication
            '5.15.0-1004.6': '5.15.0-1005.7', # config update
            '5.15.0-1057.64': '5.15.0-1058.66', # respin for LP: 2091990
        },
        'noble': {
            '~': '6.8.0-1001.3',  # Initial publication
        },
    },
    'linux-gkeop-5.4': {
        'bionic': {
            '~': '5.4.0-1007.8~18.04.1',
            '5.4.0-1007.8~18.04.1': '5.4.0-1008.9~18.04.1',
        },
    },
    'linux-gkeop-5.15': {
        'focal': {
            '~': '5.15.0-1022.27~20.04.1',
        },
    },
    'linux-ibm': {
        'focal': {
            '~': '5.4.0-1005.6',
        },
        'jammy':{
            '5.15.0-1067.70': '5.15.0-1068.71', # respin for LP: 2091990
        },
    },
    'linux-ibm-5.4': {
        'bionic': {
            '~': '5.4.0-1014.15~18.04.1',
        },
    },
    'linux-ibm-5.15': {
        'focal': {
            '~': '5.15.0-1036.39~20.04.1', #initial publication
            '5.15.0-1067.70~20.04.1': '5.15.0-1068.71~20.04.1', # respin for LP: 2091990
        },
    },
    'linux-intel-5.13': {
        'focal': {
            '~': '5.13.0-1004.4',  # initial publication
            '5.13.0-1004.4': '5.13.0-1008.8',  # Still trailing other 5.13 kernels
            '5.13.0-1008.8': '5.13.0-1009.9',  # not sure what's up with this kernel
        },
    },
    'linux-intel-iotg': {
        'jammy': {
            '5.15.0-1047.53': '5.15.0-1048.54',  # looks to have been a packaging resync
        },
    },
    'linux-intel-iotg-5.15': {
        'focal': {
            '~': '5.15.0-1027.32~20.04.1',  # up until this, we were considering this kernel as only edge binaries
        },
    },
    'linux-intel-iot-realtime': {
        'jammy': {
            '~': '5.15.0-1066.68',
            '5.15.0-1066.68': '5.15.0-1072.74', # not ready for USNs
        },
    },
    'linux-iot': {
        'focal': {
            '~': '5.4.0-1014.16',
        },
    },
    'linux-lowlatency': {
        'oracular': {
            '~': '6.11.0-1006.6',  # first non dev in -security
        },
        'jammy': {
            '5.15.0-128.138': '5.15.0-129.139', # respin for LP: 2091990
        },
    },
    'linux-lowlatency-hwe-5.15': {
        'focal': {
            '~': '5.15.0-42.45~20.04.1',  # initial publication
            '5.15.0-128.138~20.04.1': '5.15.0-129.139~20.04.1', # respin for LP: 2091990
        },
    },
    'linux-lowlatency-hwe-5.19': {
        'jammy': {
            '~': ' 5.19.0-1017.18~22.04.1',  # initial publication
        },
    },
    'linux-lowlatency-hwe-6.2': {
        'jammy': {
            '~': '6.2.0-1009.9~22.04.1',  # initial publication
        },
    },
    'linux-lowlatency-hwe-6.5': {
        'jammy': {
            '~': '6.5.0-14.14.1~22.04.1',  # initial publication
        },
    },
    'linux-lowlatency-hwe-6.8': {
        'jammy': {
            '~': '6.8.0-40.40.1~22.04.1',  # first non-edge publication
        },
    },
    'linux-kvm': {
        'xenial': {
            '4.4.0-1093.102': '4.4.0-1094.103',
            '4.4.0-1097.106': '4.4.0-1098.107',  # LP: #1939915
        },
        'bionic': {
            '4.15.0-1092.94': '4.15.0-1094.96',
        },
        'jammy': {
            '5.15.0-1071.76': '5.15.0-1072.77', # respin for LP: 2091990
        },
    },
    'linux-nvidia': {
        'jammy': {
            '~': '5.15.0-1027.27',
        },
        'noble':{
            '~': '6.8.0-1007.7',
        },
    },
    'linux-nvidia-6.2': {
        'jammy': {
            '~': '6.2.0-1010.10',
        },
    },
    'linux-nvidia-6.5': {
        'jammy': {
            '~': '6.5.0-1014.14',
            '6.5.0-1015.15': '6.5.0-1018.18', # no USN needed, but wanted in -security
        },
    },
    'linux-nvidia-6.8': {
        'jammy': {
            '~': '6.8.0-1010.10~22.04.1', # mark this as first publication
        },
    },
    'linux-nvidia-lowlatency': {
        'noble': {
            '~': '6.8.0-1009.9.1', # initial publication
        },
    },
    'linux-nvidia-tegra': {
        'jammy': {
            '~': '5.15.0-1032.32', # initial publication
        },
    },
    'linux-nvidia-tegra-igx': {
        'jammy': {
            '~': '5.15.0-1020.20', # initial publication
        },
    },
    'linux-oem': {
        'xenial': {
            '4.13.0-1031.35': '4.13.0-1032.36',
        },
        'bionic': {
            '4.15.0-1006.9': '4.15.0-1008.11',
            '4.15.0-1017.20': '4.15.0-1018.21',
            '4.15.0-1026.31': '4.15.0-1028.33',
            '4.15.0-1067.77': '4.15.0-1069.79',
            '4.15.0-1069.79': '4.15.0-1073.83',
        },
        'cosmic': { # cosmic kernels are forward copies from bionic
            '~': '4.15.0-1033.38',
            '4.15.0-1033.38': '4.15.0-1034.39',
            '4.15.0-1034.39': '4.15.0-1035.40',
            '4.15.0-1035.40': '4.15.0-1038.43',
            '4.15.0-1038.43': '4.15.0-1039.44',
            '4.15.0-1039.44': '4.15.0-1043.48',
            '4.15.0-1043.48': '4.15.0-1045.50',
        },
        'disco': { # disco kernels are forward copies from bionic
            '~': '4.15.0-1038.43',
            '4.15.0-1038.43': '4.15.0-1039.44',
            '4.15.0-1039.44': '4.15.0-1043.48',
            '4.15.0-1043.48': '4.15.0-1045.50',
            '4.15.0-1045.50': '4.15.0-1050.57',
        }
    },
    'linux-oem-5.6': {
        'focal': {
            '~': '5.6.0-1021.21',
            '5.6.0-1021.21': '5.6.0-1036.39',
            '5.6.0-1048.52': '5.6.0-1050.54',
        },
    },
    'linux-oem-osp1': {
        'bionic': {
            '~': '5.0.0-1025.28',
            '5.0.0-1033.38': '5.0.0-1037.42',
            '5.0.0-1037.42': '5.0.0-1039.44',
            '5.0.0-1039.44': '5.0.0-1040.45',
            '5.0.0-1043.48': '5.0.0-1046.51',
        },
    },
    'linux-oem-5.10': {
        'focal': {
            '~': '5.10.0-1013.14',  # initial publication
            '5.10.0-1014.15': '5.10.0-1016.17',
            '5.10.0-1022.23': '5.10.0-1023.24',
            '5.10.0-1038.40': '5.10.0-1044.46',
        },
    },
    'linux-oem-5.13': {
        'focal': {
            '~': '5.13.0-1011.15',  # initial publication
        },
    },
    'linux-oem-5.14': {
        'focal': {
            '~': '5.14.0-1005.5',  # initial publication
            '5.14.0-1050.57': '5.14.0-1051.58',  # regression fix LP: #1987690
        },
    },
    'linux-oem-5.17': {
        'jammy': {
            '5.17.0-1011.12': '5.17.0-1012.13',
            '5.17.0-1020.21': '5.17.0-1021.22', # no security fixes, LP: #1992020
        },
    },
    'linux-oem-6.0': {
        'jammy': {
            '~': '6.0.0-1007.7',  # Initial publication
        },
    },
    'linux-oem-6.1': {
        'jammy': {
            '~': '6.1.0-1004.4',  # Initial publication
            '6.1.0-1010.10': '6.1.0-1012.12', # no CVEs, deadlock issue LP: #2018566
        },
    },
    'linux-oem-6.5': {
        'jammy': {
            '~': '6.5.0-1006.6',  # Initial publication
        },
    },
    'linux-oem-6.11': {
        'noble': {
            '~': '6.11.0-1008.8',  # Initial publication
            '6.11.0-1008.8': '6.11.0-1009.9', # no CVES, wanted in -security
            '6.11.0-1017.17': '6.11.0-1018.18', # no CVES, wanted in -security
        },
    },
    'linux-oracle': {
        'xenial': {
            '~': '4.15.0-1008.10~16.04.1',
            '4.15.0-1017.19~16.04.2': '4.15.0-1018.20~16.04.1',
        },
        'bionic': {
            '~': '4.15.0-1008.10',
        },
        'disco': {  # disco kernels are carried forward from bionic
            '~': '4.15.0-1013.15',
            '4.15.0-1013.15': '4.15.0-1014.16',
            '4.15.0-1014.16': '4.15.0-1015.17',
            '4.15.0-1015.17': '4.15.0-1016.18',
            '4.15.0-1016.18': '4.15.0-1017.19',
            '4.15.0-1017.19': '4.15.0-1018.20',
            '4.15.0-1018.20': '5.0.0-1004.8',
            '5.0.0-1004.8': '5.0.0-1005.9', # sarnold forgot
        },
        'eoan': {
            '~': '5.3.0-1003.3',
        },
        'oracular': {
            '~': '6.11.0-1008.8', # first non dev in -security
        },
    },
    'linux-oracle-5.0': {
        'bionic': {
            '~': '5.0.0-1007.12~18.04.1',  # initial publication
        },
    },
    'linux-oracle-5.3': {
        'bionic': {
            '~': '5.3.0-1011.12~18.04.1',  # initial publication
        },
    },
    'linux-oracle-5.8': {
        'focal': {
            '~': '5.8.0-1031.32~20.04.2',  # initial publication
        },
    },
    'linux-oracle-5.11': {
        'focal': {
            '~': '5.11.0-1016.17~20.04.1',  # initial publication
        },
    },
    'linux-oracle-5.13': {
        'focal': {
            '~': '5.13.0-1016.20~20.04.1',  # initial publication
            '5.13.0-1027.32~20.04.1': '5.13.0-1028.33~20.04.1',  # initial publication
            '5.13.0-1033.39~20.04.1': '5.13.0-1034.40~20.04.1',  # LP: #1973620 fix
        },
    },
    'linux-oracle-5.15': {
        'focal': {
            '~': '5.15.0-1021.27~20.04.1',  # initial publication
            '5.15.0-1072.78~20.04.1': '5.15.0-1073.79~20.04.1', # respin for LP: 2091990
        },
    },
    'linux-oracle-6.5': {
        'jammy': {
            '~': '6.5.0-1018.18~22.04.1',  # initial publication
        },
    },
    'linux-oracle-6.8': {
        'jammy': {
            '~': '6.8.0-1012.12~22.04.1',  # initial publication
        },
    },
    'linux-exynos5': {  # oem linux-exynos5 accidentally miscopied to security
        'trusty': {
            '~': '3.13.0-5.6'
        }
    },
    'linux-raspi': {
        'oracular': {
            '~': '6.11.0-1005.5', #initial publication
        },
    },
    'linux-raspi2': {  # meltdown updates did not apply to linux-raspi2
        'xenial': {
            '4.4.0-1080.88': '4.4.0-1082.90',
            '4.4.0-1124.133': '4.4.0-1125.134',
            '4.4.0-1129.138': '4.4.0-1130.139',  # kernel fixed intel only issue
        },
        'bionic': {
            '4.15.0-1013.14': '4.15.0-1017.18',
            '4.15.0-1049.53': '4.15.0-1050.54',
            '4.15.0-1053.57': '4.15.0-1054.58',
            '4.15.0-1074.79': '4.15.0-1076.81',
            '4.15.0-1092.98': '4.15.0-1093.99',  # LP: #1938013
            '4.15.0-1107.114': '4.15.0-1108.115',  # LP: #1938013
        },
        'eoan': {
            '5.3.0-1012.14': '5.3.0-1014.16',
            '5.3.0-1015.17': '5.3.0-1017.19',
        },
    },
    'linux-raspi2-5.3': {
        'bionic': {
            '~': '5.3.0-1017.19~18.04.1',  # initial publication
        },
    },
    'linux-raspi-5.4': {
        'bionic': {
            '~': '5.4.0-1013.13~18.04.1',  # initial publication
        },
    },
    'linux-raspi-realtime': {
        'noble': {
            '~': '6.8.0-2017.18',
            '6.8.0-2017.18': '6.8.0-2019.20', # not ready for USNs
        },
    },
    'linux-realtime': {
        'jammy': {
            '~': '5.15.0-1077.85',
            '5.15.0-1077.85': '5.15.0-1079.87', # not ready for USNs
        },
        'noble': {
            '~': '6.8.1-1015.16',
            '6.8.1-1015.16': '6.8.1-1017.18', # not ready for USNs
        },
    },
    'linux-realtime-6.8': {
        'jammy': {
            '~': '6.8.1-1015.16~22.04.1',
            '6.8.1-1015.16~22.04.1': '6.8.1-1017.18~22.04.1',
            '6.8.1-1017.18~22.04.1': '6.8.1-1018.19~22.04.1', # not correctly tracked in UCT
            '6.8.1-1018.19~22.04.1': '6.8.1-1019.20~22.04.1',
        },
    },
    'linux-riscv': {
        # linux-riscv is problematic for USN publications because the
        # meta package used for it is linux-image-generic but with a
        # different version than the primary kernel's
        # linux-image-generic, and our USN publishing process does not
        # handle different architectures having different versions for
        # the same binary package well.
        'focal': {
            '5.4.0-30.34': '5.4.0-31.35',  # initial publication
            '5.4.0-31.35': '5.4.0-33.37',
            '5.4.0-33.37': '5.4.0-34.38',
            '5.4.0-34.38': '5.4.0-36.41',
            '5.4.0-36.41': '5.4.0-37.42',
            '5.4.0-37.42': '5.4.0-39.44',
            '5.4.0-39.44': '5.4.0-40.45',
        },
        'groovy': {
            '~': '5.8.0-8.9',  # initial publication
            '5.8.0-8.9': '5.8.0-10.12',
            '5.8.0-10.12': '5.8.0-12.14',
            '5.8.0-12.14': '5.8.0-13.15',
            '5.8.0-13.15': '5.8.0-14.16',
            '5.8.0-14.16': '5.8.0-16.18',
            '5.8.0-16.18': '5.8.0-17.19',
            '5.8.0-17.19': '5.8.0-18.20',
            '5.8.0-18.20': '5.8.0-20.22',
            '5.8.0-20.22': '5.8.0-22.24',
            '5.8.0-22.24': '5.8.0-25.27',
            '5.8.0-25.27': '5.8.0-26.28',
            '5.8.0-26.28': '5.8.0-29.31',
            '5.8.0-29.31': '5.8.0-32.35',
        },
        'hirsute': {
            '~': '5.11.0-1008.8',  # initial publication
            '5.11.0-1008.8': '5.11.0-1009.9',
            '5.11.0-1009.9': '5.11.0-1012.12',
            '5.11.0-1012.12': '5.11.0-1015.16',
            '5.11.0-1015.16': '5.11.0-1017.18',
            '5.11.0-1017.18': '5.11.0-1018.19',
            '5.11.0-1018.19': '5.11.0-1020.21',
            '5.11.0-1020.21': '5.11.0-1021.22',
            '5.11.0-1021.22': '5.11.0-1022.23',
            '5.11.0-1022.23': '5.11.0-1023.24',
            '5.11.0-1023.24': '5.11.0-1024.25',
            '5.11.0-1024.25': '5.11.0-1026.28',
            '5.11.0-1026.28': '5.11.0-1028.31',
        },
        'impish': {
            '~': '5.13.0-1005.5',  # initial publication
            '5.13.0-1005.5': '5.13.0-1006.6',
            '5.13.0-1006.6': '5.13.0-1007.7',
            '5.13.0-1007.7': '5.13.0-1008.8',
            '5.13.0-1008.8': '5.13.0-1010.11',
            '5.13.0-1010.11': '5.13.0-1011.12',
            '5.13.0-1011.12': '5.13.0-1012.14',
            '5.13.0-1012.14': '5.13.0-1015.17',
            '5.13.0-1015.17': '5.13.0-1017.19',
            '5.13.0-1017.19': '5.13.0-1019.21',
            '5.13.0-1019.21': '5.13.0-1020.22',
            '5.13.0-1020.22': '5.13.0-1021.23',
            '5.13.0-1021.23': '5.13.0-1023.25',
            '5.13.0-1023.25': '5.13.0-1026.29',
        },
        'jammy': {
            '~': '5.15.0-1008.8',  # initial publication
            '5.15.0-1008.8': '5.15.0-1011.12',
            '5.15.0-1011.12': '5.15.0-1014.16',
            '5.15.0-1014.16': '5.15.0-1015.17',
            '5.15.0-1015.17': '5.15.0-1016.18',
            '5.15.0-1016.18': '5.15.0-1017.19',
            '5.15.0-1017.19': '5.15.0-1018.21',
            '5.15.0-1018.21': '5.15.0-1019.22',
            '5.15.0-1019.22': '5.15.0-1020.23',
            '5.15.0-1020.23': '5.15.0-1022.26',
            '5.15.0-1022.26': '5.15.0-1023.27',
            '5.15.0-1023.27': '5.15.0-1026.30',
            '5.15.0-1026.30': '5.15.0-1027.31',
            '5.15.0-1027.31': '5.15.0-1028.32',
        },
        'kinetic': {
            '~': '5.19.0-1006.7',  # initial publication
            '5.19.0-1006.7':  '5.19.0-1009.10',
            '5.19.0-1009.10': '5.19.0-1011.12',
            '5.19.0-1011.12': '5.19.0-1012.13',
            '5.19.0-1012.13': '5.19.0-1013.14',
            '5.19.0-1013.14': '5.19.0-1015.16',
            '5.19.0-1015.16': '5.19.0-1016.17',
            '5.19.0-1016.17': '5.19.0-1017.18',
            '5.19.0-1017.18': '5.19.0-1018.19',
            '5.19.0-1018.19': '5.19.0-1019.21',
            '5.19.0-1019.21': '5.19.0-1020.22',
            '5.19.0-1020.22': '5.19.0-1021.23',
        },
        'lunar': {
            '~': '6.2.0-23.23.1',  # initial publication
            '6.2.0-23.23.1': '6.2.0-24.24.1',
            '6.2.0-24.24.1': '6.2.0-27.28.1',
            '6.2.0-27.28.1': '6.2.0-31.31.1',
            '6.2.0-31.31.1': '6.2.0-32.32.2',
            '6.2.0-32.32.2': '6.2.0-33.33.1',
            '6.2.0-33.33.1': '6.2.0-34.34.1',
            '6.2.0-34.34.1': '6.2.0-35.35.1',
            '6.2.0-35.35.1': '6.2.0-36.37.1',
            '6.2.0-36.37.1': '6.2.0-37.38.1',
            '6.2.0-37.38.1': '6.2.0-39.40.1',
        },
        'mantic': {
            '~': '6.5.0-10.10.1',  # initial publication
            '6.5.0-10.10.1': '6.5.0-13.13.1',
            '6.5.0-13.13.1': '6.5.0-14.14.1',
            '6.5.0-14.14.1': '6.5.0-15.15.1',
            '6.5.0-15.15.1': '6.5.0-17.17.1',
            '6.5.0-17.17.1': '6.5.0-21.21.1',
            '6.5.0-21.21.1': '6.5.0-25.25.1',
            '6.5.0-25.25.1': '6.5.0-26.26.1',
            '6.5.0-26.26.1': '6.5.0-27.28.1',
            '6.5.0-27.28.1': '6.5.0-28.29.1',
            '6.5.0-28.29.1': '6.5.0-35.35.1',
            '6.5.0-35.35.1': '6.5.0-40.40.1',
            '6.5.0-40.40.1': '6.5.0-42.42.1',
        },
        'noble': {
            '~': '6.8.0-35.35.1',  # initial publication
            '6.8.0-35.35.1': '6.8.0-36.36.1',
            '6.8.0-36.36.1': '6.8.0-38.38.1',
            '6.8.0-38.38.1': '6.8.0-39.39.1',
            '6.8.0-39.39.1': '6.8.0-40.40.1',
            '6.8.0-40.40.1': '6.8.0-41.41.1',
            '6.8.0-41.41.1': '6.8.0-44.44.1',
            '6.8.0-44.44.1': '6.8.0-47.47.1',
            '6.8.0-47.47.1': '6.8.0-48.48.1',
            '6.8.0-48.48.1': '6.8.0-49.49.1',
            '6.8.0-49.49.1': '6.8.0-50.51.1',
            '6.8.0-50.51.1': '6.8.0-51.52.1',
            '6.8.0-51.52.1': '6.8.0-52.53.1',
            '6.8.0-52.53.1': '6.8.0-53.55.1',
            '6.8.0-53.55.1': '6.8.0-55.57.1',
            '6.8.0-55.57.1': '6.8.0-56.58.1',
            '6.8.0-56.58.1': '6.8.0-57.59.1',
        },
        'oracular': {
            '~': '6.11.0-12.13.1',  # initial publication
            '6.11.0-12.13.1': '6.11.0-13.14.1',
            '6.11.0-13.14.1': '6.11.0-14.15.1',
            '6.11.0-14.15.1': '6.11.0-17.17.1',
            '6.11.0-17.17.1': '6.11.0-19.19.1',
            '6.11.0-19.19.1': '6.11.0-21.21.1',
        },
    },
    'linux-riscv-5.8': {
        'focal': {
            '~': '5.8.0-26.28~20.04.1',  # initial publication
            '5.8.0-26.28~20.04.1': '5.8.0-29.31~20.04.1'
        },
    },
    'linux-riscv-5.11': {
        'focal': {
            '~': '5.11.0-1017.18~20.04.1',  # initial publication
            '5.11.0-1017.18~20.04.1': '5.11.0-1018.19~20.04.2',
            '5.11.0-1018.19~20.04.2': '5.11.0-1020.21~20.04.1',
            '5.11.0-1020.21~20.04.1': '5.11.0-1021.22~20.04.1',
            '5.11.0-1021.22~20.04.1': '5.11.0-1022.23~20.04.1',
            '5.11.0-1022.23~20.04.1': '5.11.0-1023.24~20.04.1',
            '5.11.0-1023.24~20.04.1': '5.11.0-1024.25~20.04.1',
            '5.11.0-1024.25~20.04.1': '5.11.0-1026.28~20.04.1',
            '5.11.0-1026.28~20.04.1': '5.11.0-1028.31~20.04.1',
            '5.11.0-1028.31~20.04.1': '5.11.0-1029.32~20.04.1',
            '5.11.0-1029.32~20.04.1': '5.11.0-1030.34',
            '5.11.0-1030.34': '5.11.0-1031.35',
        },
    },
    'linux-riscv-5.15': {
        'focal': {
            '~': '5.15.0-1033.37~20.04.1',  # initial publication
            '5.15.0-1033.37~20.04.1': '5.15.0-1034.38~20.04.1',
            '5.15.0-1034.38~20.04.1': '5.15.0-1035.39~20.04.1',
            '5.15.0-1035.39~20.04.1': '5.15.0-1036.40~20.04.2',
            '5.15.0-1036.40~20.04.2': '5.15.0-1037.41~20.04.2',
            '5.15.0-1037.41~20.04.2': '5.15.0-1038.42~20.04.2',
            '5.15.0-1038.42~20.04.2': '5.15.0-1039.43~20.04.2',
            '5.15.0-1039.43~20.04.2': '5.15.0-1040.44~20.04.3',
            '5.15.0-1040.44~20.04.3': '5.15.0-1041.45~20.04.1',
            '5.15.0-1041.45~20.04.1': '5.15.0-1043.47~20.04.1',
            '5.15.0-1043.47~20.04.1': '5.15.0-1044.48~20.04.1',
            '5.15.0-1044.48~20.04.1': '5.15.0-1045.49~20.04.1',
            '5.15.0-1045.49~20.04.1': '5.15.0-1046.50~20.04.1',
            '5.15.0-1046.50~20.04.1': '5.15.0-1047.51~20.04.1',
            '5.15.0-1047.51~20.04.1': '5.15.0-1048.52~20.04.1',
            '5.15.0-1048.52~20.04.1': '5.15.0-1049.53~20.04.2',
            '5.15.0-1049.53~20.04.2': '5.15.0-1050.54~20.04.1',
            '5.15.0-1050.54~20.04.1': '5.15.0-1051.55~20.04.1',
            '5.15.0-1051.55~20.04.1': '5.15.0-1052.56~20.04.1',
            '5.15.0-1052.56~20.04.1': '5.15.0-1053.57~20.04.1',
            '5.15.0-1053.57~20.04.1': '5.15.0-1056.60~20.04.1',
            '5.15.0-1056.60~20.04.1': '5.15.0-1057.61~20.04.1',
            '5.15.0-1057.61~20.04.1': '5.15.0-1058.62~20.04.1',
            '5.15.0-1058.62~20.04.1': '5.15.0-1059.63~20.04.1',
            '5.15.0-1059.63~20.04.1': '5.15.0-1060.64~20.04.1',
            '5.15.0-1060.64~20.04.1': '5.15.0-1061.65~20.04.1',
            '5.15.0-1061.65~20.04.1': '5.15.0-1062.66~20.04.1',
            '5.15.0-1062.66~20.04.1': '5.15.0-1063.67~20.04.1',
            '5.15.0-1063.67~20.04.1': '5.15.0-1064.68~20.04.1',
            '5.15.0-1064.68~20.04.1': '5.15.0-1065.69~20.04.1',
            '5.15.0-1065.69~20.04.1': '5.15.0-1066.70~20.04.1',
            '5.15.0-1066.70~20.04.1': '5.15.0-1067.71~20.04.1',
            '5.15.0-1067.71~20.04.1': '5.15.0-1068.72~20.04.1',
            '5.15.0-1068.72~20.04.1': '5.15.0-1069.73~20.04.1',
            '5.15.0-1069.73~20.04.1': '5.15.0-1070.74~20.04.1',
            '5.15.0-1070.74~20.04.1': '5.15.0-1071.75~20.04.1', # respin for LP: 2091990
            '5.15.0-1071.75~20.04.1': '5.15.0-1072.76~20.04.1',
            '5.15.0-1072.76~20.04.1': '5.15.0-1073.77~20.04.1',
            '5.15.0-1073.77~20.04.1': '5.15.0-1074.78~20.04.1',
            '5.15.0-1074.78~20.04.1': '5.15.0-1075.79~20.04.1',
            '5.15.0-1075.79~20.04.1': '5.15.0-1076.80~20.04.1',
        },
    },
    'linux-riscv-5.19': {
        'jammy': {
            '~': '5.19.0-1020.22~22.04.1',  # initial publication
            '5.19.0-1020.22~22.04.1': '5.19.0-1021.23~22.04.1',
        },
    },
    'linux-riscv-6.5': {
        'jammy': {
            '~': '6.5.0-17.17.1.1~22.04.1',  # initial publication
            '6.5.0-17.17.1.1~22.04.1': '6.5.0-21.21.1~22.04.1',
            '6.5.0-21.21.1~22.04.1': '6.5.0-25.25.1~22.04.1',
            '6.5.0-25.25.1~22.04.1': '6.5.0-26.26.1~22.04.1',
            '6.5.0-26.26.1~22.04.1': '6.5.0-27.28.1~22.04.1',
            '6.5.0-27.28.1~22.04.1': '6.5.0-28.29.1~22.04.1',
            '6.5.0-28.29.1~22.04.1': '6.5.0-35.35.1~22.04.1',
            '6.5.0-35.35.1~22.04.1': '6.5.0-40.40.1~22.04.1',
            '6.5.0-40.40.1~22.04.1': '6.5.0-42.42.1~22.04.1',
        },
    },
    'linux-riscv-6.8': {
        'jammy': {
            '~': '6.8.0-40.40.1~22.04.1',  # first non-edge publication
            '6.8.0-40.40.1~22.04.1': '6.8.0-41.41.1~22.04.1',
            '6.8.0-41.41.1~22.04.1': '6.8.0-44.44.1~22.04.1',
            '6.8.0-44.44.1~22.04.1': '6.8.0-47.47.1~22.04.1',
            '6.8.0-47.47.1~22.04.1': '6.8.0-48.48.1~22.04.2',
            '6.8.0-48.48.1~22.04.2': '6.8.0-49.49.1~22.04.1',
            '6.8.0-49.49.1~22.04.1': '6.8.0-50.51.1~22.04.1',
            '6.8.0-50.51.1~22.04.1': '6.8.0-51.52.1~22.04.1',
            '6.8.0-51.52.1~22.04.1': '6.8.0-52.53.1~22.04.1',
            '6.8.0-52.53.1~22.04.1': '6.8.0-53.55.1~22.04.1',
            '6.8.0-53.55.1~22.04.1': '6.8.0-55.57.1~22.04.1',
            '6.8.0-55.57.1~22.04.1': '6.8.0-56.58.1~22.04.1',
            '6.8.0-56.58.1~22.04.1': '6.8.0-57.59.1~22.04.1',
        },
    },
    'linux-starfive': {
        'kinetic': {
            '~': '5.19.0-1019.21',  # initial publication
        },
        'lunar': {
            '~': '6.2.0-1002.2',  # initial publication
        },
    },
    'linux-starfive-5.19': {
        'jammy': {
            '~': '5.19.0-1019.21~22.04.1',  # initial publication
        },
    },
    'linux-starfive-6.2': {
        'jammy': {
            '~': '6.2.0-1006.7~22.04.1',  # initial publication
        },
    },
    'linux-starfive-6.5': {
        'jammy': {
            '~': '6.5.0-1007.8~22.04.1',  # initial publication
        },
    },
    'linux-ti-omap4': {
        'precise': {
            '3.2.0-1483.110': '3.2.0-1484.111'
        },
    },
    'linux-keystone': {  # oem linux-keystone added post-release and
                         #  no USNs, so use '~', '<version in security>
        'trusty': {
            # '~': '3.13.0-43.68'
            '~': '3.13.0-68.96',
        },
    },
    'linux-snapdragon': {  # meltdown updates did not apply to linux-snapdragon
        'xenial': {
            '4.4.0-1081.86': '4.4.0-1084.89',
            '4.4.0-1118.124': '4.4.0-1121.127',
            '4.4.0-1128.136': '4.4.0-1129.137',
            '4.4.0-1133.141': '4.4.0-1134.142',  # kernel fixed intel only issue
        },
        'yakkety': {
            '~': '4.4.0-1063.68'
        },
        'zesty': {
            '~': '4.4.0-1081.86'
        },
        'artful': {
            '~': '4.4.0-1095.100'
        },
        'bionic': {
            '4.15.0-1060.66': '4.15.0-1062.69',
            '4.15.0-1066.73': '4.15.0-1067.74',
            '4.15.0-1070.77': '4.15.0-1071.78',
            '4.15.0-1109.118': '4.15.0-1110.119',  # LP: #1938013
        },
        'disco': {
            '~': '5.0.0-1012.12',
        },
    },
    'linux-lts-utopic': {  # first release of utopic backport kernel
        'trusty': {
            # '~': '3.16.0-25.33~14.04.2'
            '3.16.0-46.62~14.04.1': '3.16.0-49.65~14.04.1'
        }
    },
    'linux-lts-vivid': {  # zombie vivid lives on
        'trusty': {
            '3.19.0-66.74~14.04.1': '3.19.0-80.88~14.04.1',
        }
    },
    'linux-lts-wily': {  # wily lts accidentally miscopied to security
        'trusty': {
            '4.2.0-18.22~14.04.1': '4.2.0-19.23~14.04.1',
        }
    },
    'linux-lts-xenial': {
        'trusty': {
            # only change in 4.4.0-112.135~14.04.1 is NOBP config for s390x,
            # which is not a supported arch for Ubuntu 14.04 LTS.
            '4.4.0-111.134~14.04.1': '4.4.0-112.135~14.04.1',
            '4.4.0-210.242~14.04.1': '4.4.0-211.243~14.04.1',
            '4.4.0-214.246~14.04.1': '4.4.0-215.247~14.04.1',  # LP: #1939915
        }
    },
    'linux-hwe': {  # hwe kernel initial publication
        'xenial': {
            '~': '4.8.0-39.42~16.04.1',
            '4.15.0-151.157~16.04.1': '4.15.0-153.160~16.04.1',  # LP: #1938013
            '4.15.0-194.205~16.04.1': '4.15.0-196.207~16.04.1',  # LP: #1994601
        },
        'bionic': {
            '~': '4.18.0-13.14~18.04.1',
        },
    },
    'linux-hwe-5.4': {  # hwe kernel initial publication
        'bionic': {
            '~': '5.4.0-40.44~18.04.1',
        },
    },
    'linux-hwe-5.8': {
        'focal': {
            '~': '5.8.0-33.36~20.04.1',  # hwe kernel initial publication
        },
    },
    'linux-hwe-5.11': {
        'focal': {
            '5.11.0-41.45~20.04.1': '5.11.0-43.47~20.04.2',  # LP: #1949063
        },
    },
    'linux-hwe-5.13': {
        'focal': {
            '~': '5.13.0-27.29~20.04.1',  # initial publication
        },
    },
    'linux-hwe-5.15': {
        'focal': {
            '~': '5.15.0-41.44~20.04.1',  # initial publication
        },
    },
    'linux-hwe-5.19': {
        'jammy': {
            '~': '5.19.0-28.29~22.04.1',  # initial publication
        },
    },
    'linux-hwe-6.2': {
        'jammy': {
            '~': '6.2.0-26.26~22.04.1',  # initial publication
        },
    },
    'linux-hwe-6.5': {
        'jammy': {
            '~': '6.5.0-14.14~22.04.1',  # initial publication
            '6.5.0-17.17~22.04.1': '6.5.0-18.18~22.04.1', # respin for driver update
        },
    },
    'linux-hwe-6.8': {
        'jammy': {
            '~': '6.8.0-40.40~22.04.3',  # first non-edge publication
        },
    },
    'linux-xilinx-zynqmp': {
        'focal': {
            '~': '5.4.0-1022.26', # initial publication
        },
        'jammy': {
            '~': '5.15.0-1022.26', # initial publication
            '5.15.0-1022.26': '5.15.0-1023.27', # development kernel
            '5.15.0-1023.27': '5.15.0-1025.29', # development kernel
            '5.15.0-1025.29': '5.15.0-1027.31', # development kernel
        },
    }
}


def lookup_glitch_version(src, release, version):
    glitch_version = None
    if src in kernel_glitches and release in kernel_glitches[src]:
        test_version = version
        while test_version in kernel_glitches[src][release]:
            test_version = kernel_glitches[src][release][test_version]
        if test_version != version:
            glitch_version = test_version

    return glitch_version


# list of kernel meta abi versions to ignore abi mismatches when
# published in the archive.
kernel_mabi_glitches = {
    'linux-meta': {
        'bionic': [
            '4.15.0.23.25',  # -24 got reverted due to LP: #1780227
        ],
    },
    'linux-meta-aws': {
        'bionic': [
            '4.15.0.1010.10',  # -1011 got reverted due to LP: #1780227
        ],
    },
    'linux-meta-aws-hwe': {
        'xenial': [
            '4.15.0.1085.81',  # -1008 got reverted due to LP: #1907262
        ],
    },
    'linux-meta-azure': {
        'trusty/esm': [
            '4.15.0.1122.95',  # 4.15.0-1123.136~14.04.1 got reverted
        ],
        'xenial': [
            '4.15.0.1013.20',  # -1014 got reverted due to LP: #1780227
            '4.15.0.1055.58',  # -1055 got reverted
            '4.15.0.1098.92',  # -1100 got reverted due to LP: #1907262
        ],
        'esm-infra/xenial': [
            '4.15.0.1122.113',  # 4.15.0-1123.136~16.04.1 got reverted
        ],
        'bionic': [
            '4.15.0.1013.13',  # -1014 got reverted due to LP: #1780227
            '5.0.0.1028.39',  # -1029 got reverted due to SGX blacklisting
            '5.0.0.1035.46',  # -1036 got accidentally reverted
        ],
        'focal': [
            '5.4.0.1056.54',  # 5.4.0-1058.60 got reverted
            '5.4.0.1139.133',  # unclear why
        ],
        'hirsute': [
            '5.11.0.1013.14',  # 5.11.0-1015.16 got reverted
        ],
        'noble': [
            '6.8.0-1016.18',  # unclear why
        ],
    },
    'linux-meta-azure-4.15': {
        'bionic': [
            '4.15.0.1122.95',  # 4.15.0-1123.136 got reverted
        ],
    },
    'linux-meta-azure-5.4': {
        'bionic': [
            '5.4.0.1056.36',  # 5.4.0-1058.60~18.04.1 got reverted
        ],
    },
    'linux-meta-bluefield': {
        'focal': [
            '5.4.0.1094.90',  # unclear why
        ],
    },
    'linux-meta-gcp': {
        'xenial': [
            '4.15.0.1087.88',  # -1088 got reverted due to LP: #1907262
        ],
        'bionic': [
            '4.15.0.1009.11',  # -1010 got reverted due to LP: #1780227
        ],
        'noble': [
            '6.8.0-1016.18',  # unclear why
        ],
    },
    'linux-meta-gcp-5.4': {
        'bionic': [
            '5.4.0.1058.44',  # 5.4.0-1059.63~18.04.1 got reverted for unknown reasons
        ],
    },
    'linux-meta-gkeop-5.4': {
        'bionic': [
            '5.4.0.1027.28~18.04.28',  # 5.4.0-1059.63~18.04.1 got reverted for unknown reasons
        ],
    },
    'linux-meta-hwe': {
        'xenial': [
            '4.13.0.45.64',  # 4.15.0-24.26~16.04.1 got reverted due to LP: #1780227
            '4.15.0.123.123',  # -126 got reverted due to LP: #1907262
        ],
    },
    'linux-meta-ibm': {
        'noble': [
            '6.8.0-1014.14',  # unclear why
        ],
    },
    'linux-meta-lts-xenial': {
        'trusty': [
            '4.4.0.142.122',  # -143 got reverted due to bad dependency
        ]
    },
    'linux-meta-kvm': {
        'bionic': [
            '4.15.0.1011.11',  # -1012 got reverted due to LP: #1780227
        ],
    },
    'linux-meta-oem-5.14': {
        'focal': [
            '5.14.0.1050.46',  # not sure why -1051 did not get published to focal-security
        ],
    },
    'linux-meta-oracle': {
        'xenial': [
            '4.15.0.1058.47',  # -1059 got reverted due to LP: #1907262
        ],
    },
}

# list of kernel signed abi versions to ignore abi mismatches when
# published in the archive.
kernel_signed_abi_glitches = {
    'linux-signed-azure': {
        'focal': [
            '5.4.0-1139.146',  # unclear why
        ],
        'noble': [
            '6.8.0-1016.18',  # unclear why
        ],
    },
    'linux-signed-bluefield': {
        'focal': [
            '5.4.0-1094.101',  # unclear why
        ],
    },
    'linux-signed-gcp': {
        'noble': [
            '6.8.0-1016.18',  # unclear why
        ],
    },
    'linux-signed-ibm': {
        'noble': [
            '6.8.0-1014.14',  # unclear why
        ],
    },
}

# for a period of time, there won't be a current linux-hwe-edge or
# linux-azure-edge kernel, and the meta package will point to the
# linux-hwe or linux-azure kernels. Use this exception list to check the
# alternate kernel abi.
kernel_mabi_alt_pkg = {
    'linux-meta-azure-edge': 'linux-azure',
    'linux-meta-hwe-edge': 'linux-hwe',
}

def ignore_kernel_mabi(src, meta_src, release, version):
    return (meta_kernels.ignore_mabi(release, src) or
            (meta_src in kernel_mabi_glitches and
             release in kernel_mabi_glitches[meta_src] and
             version in kernel_mabi_glitches[meta_src][release]))

def ignore_kernel_signed_abi(src, signed_src, release, version):
    return (signed_src in kernel_signed_abi_glitches and
            release in kernel_signed_abi_glitches[signed_src] and
            version in kernel_signed_abi_glitches[signed_src][release])

def get_kernel_meta_alt_pkg(meta_src):
    return kernel_mabi_alt_pkg.get(meta_src)


# return the kernel abi from a kernel version
# e.g. 4.15.0-45.54 => 45
def kernel_package_abi(version):
    return int(version.split('-').pop().split('.', 1)[0])


# return the upstream kernel version from a kernel package version
# e.g. 4.15.0-45.54 => 4.15.0
def kernel_package_version(version):
    return version.split('-')[0]


# return the kernel abi from a kernel meta-package version
# e.g. 4.15.0.45.57 => 45
# noble meta packages changed their versioning scheme to match the
# main kernel package abi scheme UPSTREAM_VERSION-ABI.BUILD
def kernel_meta_abi(version, offset=3):
    if '-' in version:
        return kernel_package_abi(version)
    else:
        return int(version.split('.').pop(offset))


def get_kernel_break_fix(cve):
    '''Return the break-fix commits of a giver kernel CVE'''

    break_commits = []
    fix_commits = []

    cve_data = load_cve(find_cve(cve))
    if cve_data and cve_data['patches']['linux']:
        for (patch_type, break_fix) in cve_data['patches']['linux']:
            if patch_type == 'break-fix':
                break_commit, fix_commit = break_fix.split()[:2]

                for entry in break_commit.split('|'):
                    if entry != '-':
                        break_commits.append(entry)
                for entry in fix_commit.split('|'):
                    if entry != '-':
                        fix_commits.append(entry)

    return break_commits, fix_commits


def is_kernel_cna_cve(cve):
    '''Check if a given CVE was published by the Kernel CNA'''

    year = cve.split('-')[1]

    config = read_uct_config()
    if 'linux_cna_tracker' in config:
        if os.path.exists(os.path.join(config['linux_cna_tracker'], "cve", "published", year, cve)):
            return True
        return False

    print("WARNING: Couldn't find linux_cna_tracker repo, will try to verify it online." , file=sys.stderr)

    url = ("https://git.kernel.org/pub/scm/linux/security/vulns.git/tree/cve/published/%s/%s" % (year, cve))

    try:
        with urllib.request.urlopen(url) as response:
            if response.getcode() == 200:
                return True
            else:
                print("WARNING: Failed to get OK response from URL %s: %s" % (url, response.getcode()), file=sys.stderr)
                return False
    except urllib.error.HTTPError as e:
        print("WARNING: Failed to fetch patch URL %s: %s" % (url, str(e)), file=sys.stderr)
        return False


def get_affected_subsystems(commits):
    '''Return the kernel subsystems affected by a list of commits'''

    config = read_uct_config()
    if 'linux_kernel_path' not in config:
        raise ValueError("linux_kernel_path not configured, please read README.linux")

    subsystems = {}
    other_files = []
    kernel_paths_overrides = load_json_file_overrides("kernel_paths_overrides.json")

    pwd = os.getcwd()
    os.chdir(config['linux_kernel_path'])

    for _commits in commits:
        for commit in _commits:
            if not re.fullmatch(r"[0-9a-f]{4,40}", commit):
                continue

            rc, output = cmd(['git', 'show', '--name-only', '--pretty=format:', commit])
            if rc !=0:
                os.chdir(pwd)
                raise ValueError('failed to get file names from commit %s:\n%s' % (commit, output))

            files_changed = output.splitlines()
            for file_path in files_changed:
                matched_subsystem = False
                for kernel_path in kernel_paths_overrides:
                    if file_path.startswith(kernel_path):
                        if kernel_paths_overrides[kernel_path] not in subsystems:
                            subsystems[kernel_paths_overrides[kernel_path]] = set()
                        subsystems[kernel_paths_overrides[kernel_path]].add(file_path)
                        matched_subsystem = True
                        break
                if not matched_subsystem:
                    if file_path not in other_files:
                        other_files.append(file_path)

    os.chdir(pwd)

    # sort alphabetically by kernel hierarchy tree
    sorted_subsystems = {key: sorted(value) for key, value in sorted(subsystems.items(), key=lambda item: sorted(item[1]))}
    other_files.sort()

    return sorted_subsystems, other_files

def get_kernel_pending_fixes(cves, package, prev_version, curr_version, only_releases=None, forced_cves=None):
    '''Return a sorted list of cves marked as pending for the current version of a package'''
    reportable = set(['pending', 'released'])
    res = set()
    for name in cves:
        cve = cves[name]
        if package not in cve['pkgs']:
            continue
        for release in cve['pkgs'][package]:
            if ((release in ['upstream', 'product', 'snap']) or (only_releases and release not in only_releases)):
                continue
            state, version = cve['pkgs'][package][release]
            if not (forced_cves and name in forced_cves):
                if state not in reportable:
                    continue
                if version_compare(prev_version, version) >= 0:
                    continue
                if version_compare(version, curr_version) > 0:
                    continue
            res.add((name, package, release, state, version))
    return sorted(res, key=lambda x: x[0])

def print_pending_fixes(cves, pending_fixes, curr_version, out=sys.stdout, states=True, descriptions=True, warn=True, fixes=False, forced_cves=None):
    '''Print a report of which CVEs are pending to be fixed (or marked released) since
    a given version of a specific package.'''
    fixed = set()
    warn_version_mismatch = False
    for name, package, rel, state, version in pending_fixes:
        cve = cves[name]
        report = name
        if states:
            report += f" {package} {rel} {state} {version}"
            if state != 'pending' and warn:
                report += f"\n[== WARNING state {state} is not pending WARNING ==]"

        if fixes:
            pkg = 'linux' if package in kernel_srcs else package
            for (patch_type, patch) in cve['patches'][pkg]:
                if patch_type == 'break-fix':
                    report += '\n %s' % patch.split()[1]

        if descriptions:
            desc = cve['Ubuntu-Description'].strip()
            if len(desc):
                desc = " " + "\n ".join(desc.split('\n'))
            else:
                desc = " [XXX-NEEDED-XXX]"
            report += "\n" + desc

            # issue a warning if pending/released version is not the same as
            # the current version
            if version_compare(version, curr_version) < 0 and not (forced_cves and name in forced_cves):
                report += f"\n[== WARNING version {version} is older than {curr_version} WARNING ==]\n"
                warn_version_mismatch = True

        fixed.add(report)
    for cve in sorted(fixed):
        print(cve, file=out)

    if warn and warn_version_mismatch:
        print("========================================================", file=out)
        print("Mismatch between expected versions and pending versions,", file=out)
        print("Is this an embargoed security update?", file=out)

def cves_need_description(cves, pending_cves):
    '''Return True if any pending cve is missing Ubuntu-Description, False otherwise.'''
    for name in pending_cves:
        cve = cves[name]
        desc = cve['Ubuntu-Description'].strip()
        if not len(desc):
            return True
    return False


# Maps kernel flavors in LSNs to kernel source packages
KERNEL_FLAVOR_SRCPKG_MAPPING = {
    "trusty": {
        "generic-4.4": "linux-lts-xenial",
        "lowlatency-4.4": "linux-lts-xenial",
    },
    "xenial": {
        "aws": "linux-aws",
        "aws-hwe": "linux-aws-hwe",
        "azure": "linux-azure",
        "fips": "linux-fips",
        "gcp": "linux-gcp",
        "generic-4.15": "linux-hwe",
        "generic-4.4": "linux",
        "lowlatency-4.15": "linux-hwe",
        "lowlatency-4.4": "linux",
    },
    "bionic": {
        "aws": "linux-aws",
        "aws-5.4": "linux-aws-5.4",
        "aws-fips": "linux-aws-fips",
        "azure": "linux-azure",
        "azure-4.15": "linux-azure-4.15",
        "azure-5.4": "linux-azure-5.4",
        "azure-fips": "linux-azure-fips",
        "fips": "linux-fips",
        "gcp": "linux-gcp",
        "gcp-4.15": "linux-gcp-4.15",
        "gcp-5.4": "linux-gcp-5.4",
        "generic-4.15": "linux",
        "generic-5.4": "linux-hwe-5.4",
        "gke-4.15": "linux-gke-4.15",
        "gke-5.4": "linux-gke-5.4",
        "gkeop-5.4": "linux-gkeop-5.4",
        "ibm-5.4": "linux-ibm-5.4",
        "lowlatency-4.15": "linux",
        "lowlatency-5.4": "linux-hwe-5.4",
        "oem": "linux-oem",
        "oracle": "linux-oracle",
    },
    "focal": {
        "aws": "linux-aws",
        "aws-5.15": "linux-aws-5.15",
        "azure": "linux-azure",
        "azure-5.15": "linux-azure-5.15",
        "gcp": "linux-gcp",
        "gcp-5.15": "linux-gcp-5.15",
        "generic-5.15": "linux-hwe-5.15",
        "generic-5.4": "linux",
        "gke": "linux-gke",
        "gke-5.15": "linux-gke-5.15",
        "gkeop": "linux-gkeop",
        "ibm": "linux-ibm",
        "ibm-5.15": "linux-ibm-5.15",
        "lowlatency-5.15": "linux-lowlatency-hwe-5.15",
        "lowlatency-5.4": "linux",
        "oracle": "linux-oracle",
        "oracle-5.15": "linux-oracle-5.15",
    },
    "jammy": {
        "aws": "linux-aws",
        "aws-6.2": "linux-aws-6.2",
        "aws-6.5": "linux-aws-6.5",
        "azure": "linux-azure",
        "azure-6.2": "linux-azure-6.2",
        "azure-6.5": "linux-azure-6.5",
        "gcp": "linux-gcp",
        "gcp-6.2": "linux-gcp-6.2",
        "gcp-6.5": "linux-gcp-6.5",
        "gke": "linux-gke",
        "hwe-6.2": "linux-hwe-6.2",
        "hwe-6.5": "linux-hwe-6.5",
        "ibm": "linux-ibm",
        "linux": "linux",
        "lowlatency": "linux-lowlatency",
        "oracle": "linux-oracle",
    },
    "noble": {
        "aws": "linux-aws",
        "azure": "linux-azure",
        "gcp": "linux-gcp",
        "ibm": "linux-ibm",
        "linux": "linux",
    },
}
