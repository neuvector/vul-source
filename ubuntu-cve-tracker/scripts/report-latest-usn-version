#!/usr/bin/env python3
#
# SPDX-License-Identifier: GPL-3.0-only 
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# report the version of the given package in the most recent USN for it.
#
# Author: Kees Cook <kees@ubuntu.com>
# Author: Steve Beattie <sbeattie@ubuntu.com>
# Copyright 2011 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.


# Fetch the USN database first. Override location with --database
#  wget http://people.canonical.com/~ubuntu-security/usn/database.pickle


from __future__ import print_function

import cve_lib
import optparse
import usn_lib
from lp_lib import UCTLaunchpad

def setup():
    parser = optparse.OptionParser()
    parser.add_option("-D", "--database", help="Specify location of USN data (default 'database.pickle')", default="database.pickle")
    parser.add_option("-r", "--release", help="Specify comma-separated list of which release to limit the search to (default is all)")
    parser.add_option("-d", "--debug", dest="debug", help="Report additional debugging while processing", action='store_true')
    parser.add_option("-g", "--use-glitchdb", dest="use_glitches", help="use kernel version glitchdb as fallback for last USN", action='store_true', default=False)
    return parser.parse_args()

def main():
    (opt, args) = setup()

    releases = None
    if opt.release:
        releases = opt.release.split(',')
    else:
        releases = [r for r in cve_lib.releases if cve_lib.is_active_release(r)]

    uctlp = UCTLaunchpad(opt)

    usndb = usn_lib.USNdb(args, opt.database, releases, opt)
    for pkg in args:
        for rel in releases:
            version = usndb.get_latest_usn_version(pkg, rel)
            if not version:
                version = uctlp.get_earliest_version(rel, pkg)
            print(version)


if __name__ == "__main__":
    main()
