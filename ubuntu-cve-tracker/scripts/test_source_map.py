#!/usr/bin/env pytest
#
# SPDX-License-Identifier: GPL-3.0-only 
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# help with testing the source_map.py script.
#
# Author: David Fernandez Gonzalez <david.fernandezgonzalez@canonical.com>
# Copyright 2023 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.


import pytest
import source_map
import cve_lib
import mock

mock_subprojects = {
    "esm-foo/bar": {
        "eol": False,
        "oval": False,
        "components": ["main", "restricted"],
        "packages": ["test/esm-fake-supported.txt"],
        "name": "Ubuntu 01.01 ESM",
        "codename": "Fabulous Fake",
        "ppas": [{"ppa": "ubuntu-esm/esm-bar-security/ubuntu", "pocket": "main"}],
        "parent": "ubuntu/bar",
        "description": "Available with Ubuntu Pro: https://ubuntu.com/pro",
        "stamp": 1618963200,
    }
}

class TestSubprojects:
    @mock.patch("cve_lib.subprojects", mock_subprojects)
    @mock.patch("source_map._find_sources")
    def test_load_subproject_supported(self, _find_sources_mock):
        _find_sources_mock.return_value = []
        map = source_map.load(releases=['esm-foo/bar'])
        assert set(map['esm-foo/bar'].keys()) == set(['foo', 'bar'])

    @pytest.mark.parametrize("release", cve_lib.get_active_esm_releases())
    @mock.patch("source_map._find_sources")
    def test_subproject_esm(self, _find_sources_mock, release):
        _find_sources_mock.return_value = []
        packages = []

        if release not in cve_lib.subprojects:
            for rel in cve_lib.subprojects:
                if 'alias' in cve_lib.subprojects[rel] and \
                cve_lib.subprojects[rel]['alias'] == release:
                    release = rel
                    break

        for package_input_file in cve_lib.subprojects[release]['packages']:
            with open(package_input_file) as data:
                packages += data.read().splitlines()

        packages_clean = set()
        for package in packages:
            package = package.split('#', maxsplit=1)[0].strip()
            if package:
                packages_clean.add(package)

        map = source_map.load(releases=[release])
        assert set(map[release].keys()) == packages_clean