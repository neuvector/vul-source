#!/usr/bin/env python3
#
# SPDX-License-Identifier: GPL-3.0-only 
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# list the packages (and their versions) in a PPA (optionally for a given series)
#
# Author: Mike Salvatore <mike.salvatore@canonical.com>
# Copyright 2019 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.

import lpl_common
import argparse
import sys

def print_error_and_exit(parser, msg):
    print(msg + " \n")
    parser.print_help()
    sys.exit(1)

def parse_args():
    parser = argparse.ArgumentParser()
    parser.add_argument("-r", "--release", help="List packages for this ubuntu series (if none specified, will list for all)",
                        action="store")
    parser.add_argument("ppa", metavar='PPA', help="List packages for this ubuntu series (i.e. \"ubuntu-security/ppa\"",
                        action="store")

    args = parser.parse_args()
    return args

def get_records_from_ppa(opt):
    lp = lpl_common.connect()
    distribution = lp.distributions['ubuntu']
    ubuntu = lp.distributions['ubuntu']
    series = None
    if opt.release:
        series = ubuntu.getSeries(name_or_version=opt.release)
    archive, group, ppa = lpl_common.get_archive(opt.ppa, lp, False, distribution=distribution)
    return archive.getPublishedSources(status='Published', distro_series=series)


args = parse_args()
records = get_records_from_ppa(args)

for record in records:
    print('%s:%s [%s]' % (record.source_package_name, record.source_package_version, record.distro_series.name))
