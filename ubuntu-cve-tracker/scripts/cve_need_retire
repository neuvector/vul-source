#!/bin/bash

# Author: Jamie Strandboge <jamie@ubuntu.com>
# Author: Kees Cook <kees@ubuntu.com>
# Author: Marc Deslauriers <marc.deslauriers@ubuntu.com>
# Author: Steve Beattie <sbeattie@ubuntu.com>
# Copyright (C) 2005-2023 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 2 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.

set -e

#
# Usage:
# ./scripts/cve_need_retire [-p]
#

cvedir="./active"

help() {
    cat <<EOM
Uasge: cve_need_retire [-f] [-p] [-u] [-s] [CVE list]"

  -f	full listing
  -r	report (first) package
  -p	list path to CVE
  -u	move the files to retired directory
  -c	commit the changes to git (requires -u)
  -s	skip subprojects
  -h	this help statement

A list of CVEs can be given to operate on a subset of the repo
EOM
}

full=
update=
commit=
path=
report_pkg=
cves=
skip_subprojects=

while getopts "fhucprs" opt ; do
    case "$opt" in
        f) full="yes";;
        u) update="yes";;
        c) commit="yes";;
        p) path="$cvedir/";;
        r) report_pkg="yes";;
        s) skip_subprojects="yes";;
        h) help ; exit 0;;
        ?) help ; exit 1;;
    esac
done
shift $((OPTIND - 1))

if [ "$#" -gt 0 ] ; then
    cves="$*"
fi

vcs=bzr
if [ -d ".git" ]; then
    vcs=git
fi

if [ -n "${commit}" ] && [ -z "${update}" ] ; then
    echo "commit option (-c) requires update option (-u)"
    echo
    help
    exit 1
fi
if [ -z "${skip_subprojects}" ] && [ ! -L "subprojects" ]; then
    echo "subprojects symlink not found, use -s to explicitly skip subprojects"
    echo
    exit 1
elif [ -z "${skip_subprojects}" ]; then
    last_subproject_pull=$(stat -c %Y subprojects/.git/FETCH_HEAD)
    now=$(date +%s)
    if [ "$(($now - $last_subproject_pull))" -gt "86400" ]
    then
        echo "last subprojects update was more than a day ago, please run \"cd \$UCT/subprojects && git checkout main && git pull --ff-only\""
    fi
fi

ubuntu_table="./scripts/ubuntu-table -r"
if [ -n "${skip_subprojects}" ]; then
    ubuntu_table="$ubuntu_table --skip-subprojects"
fi
# don't wrap $cves in quotes because we want it to be ignored if there
# are none passed, as well as we want the contents to be treated as
# individual arguments
# shellcheck disable=SC2086
ubuntu_table_cmdline="$ubuntu_table $cves 2>&1 >/dev/null"
if ! ubuntu_table=$(eval "$ubuntu_table_cmdline")
then
    echo "\"$ubuntu_table_cmdline\" failed"
    echo
    exit 1
fi

echo "$ubuntu_table" | grep '^retire: ' | while read -r junk cve
do
    if [ -z "$full" ]; then
        if [ -z "$update" ]; then
            if [ -z "$report_pkg" ] ; then
                echo "$path$cve"
            else
                first_pkg=$(grep -m1 '^upstream_' "active/$cve" | cut -d _ -f2 | cut -d : -f1)
                echo "$path$cve: $first_pkg"
            fi
        else
            sed -i 's/^Assigned-to: .*/Assigned-to:/g' "active/$cve"
            $vcs add "active/$cve"
            $vcs mv -v "active/$cve" retired
        fi
    else
        cat "$cvedir/$cve"
        echo "--"
    fi
done

if [ -n "$update" ] && [ "$vcs" = "git" ] ; then
    count=$(git diff --cached --name-only --diff-filter=AMR HEAD | grep -c retired)
    changes=$(git diff --cached --name-only --diff-filter=AMR HEAD | grep retired | xargs grep -h '^Patches_'  | cut -d_ -f2 | tr -d : | sort | uniq -c | awk '{ printf("%s(%s)\n", $2, $1) }' | fmt -w70 | sed -e 's/^/  /')
    if [ "${count}" = "1" ] ; then
        message="$(printf "Retired 1 CVE\n\nPackages affected:\n%s\n" "${changes}")"
    else
        message="$(printf "Retired %s CVEs\n\nPackages affected:\n%s\n" "${count}" "${changes}")"
    fi

    if [ -z "${commit}" ] ; then
        echo "${message}"
    else
        git commit -sem "${message}"
    fi
fi
