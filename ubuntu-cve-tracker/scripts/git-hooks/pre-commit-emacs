#!/bin/bash
#
# SPDX-License-Identifier: GPL-3.0-only 
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# serve as a git pre-commit hook that will inspect elisp warnings.
#
# Author: Alex Murray <alex.murray@canonical.com>
# Copyright 2022 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.


# This hook will check for byte-compiler warnings any elisp files to be
# committed. The hook should exit with non-zero status after issuing an
# appropriate message to the user asking wether to ignore the warnings or
# not.


MODIFIED_FILES=$(git diff --name-only --cached)
ERRORS=0
for file in ${MODIFIED_FILES}; do
  IS_ELISP=$(file "$file" | grep "Lisp/Scheme program")
  if [[ $IS_ELISP != "" ]]; then
    EMACS=$(command -v emacs)
    if [[ $EMACS != "" ]]; then
      # emacs will exit with non-zero on errors but will still emit
      # warnings to stdout - we only want to block the commit if there are
      # actual errors since the byte-compiler is quite noisy
      $EMACS -q --batch --directory "$(dirname "$file")" -f batch-byte-compile "$file"
      ERRORS=$((ERRORS + $?))
      # remove the compiled elc file afterwards
      rm -f "${file}c"
    fi
  fi
done

if [[ $ERRORS -gt 0 ]]; then
  read -r -p 'Found emacs errors. Enter "ignore" to continue or anything else to exit: ' answer < /dev/tty
  if [ "${answer}" != "ignore" ]; then
    exit 1
  fi
fi

