#!/bin/bash
#
# SPDX-License-Identifier: GPL-3.0-only 
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# serve as a git pre-commit hook.
#
# Author: Alex Murray <alex.murray@canonical.com>
# Author: Amir Naseredini <amir.naseredini@canonical.com>
# Author: Steve Beattie <steve.beattie@canonical.com>
# Copyright 2018 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.


# A hook script to verify what is about to be committed.
# Called by "git commit" with no arguments.  The hook should
# exit with non-zero status after issuing an appropriate message if
# it wants to stop the commit.
#
# To enable this hook, rename this file to "pre-commit".
#
# this script is a bash script due to the use of 'read -p'


SUBPROJECTS=$(git rev-parse --show-toplevel)/subprojects
EMBARGOED=$(git rev-parse --show-toplevel)/embargoed

if git rev-parse --verify HEAD >/dev/null 2>&1
then
    against=HEAD
else
    # Initial commit: diff against an empty tree object
    against=4b825dc642cb6eb9a060e54bf8d69288fbee4904
fi

# Redirect output to stderr.
exec 1>&2

cleanup() {
    if [ -n "${modified_files}" ] && [ -f "${modified_files}" ]  ; then
        rm "${modified_files}"
    fi
    if [ -n "${modified_json_files}" ] && [ -f "${modified_json_files}" ]  ; then
        rm "${modified_json_files}"
    fi
}

set -e

trap cleanup EXIT INT HUP

# Check for unstaged changes in staged files from active
staged_active=$(git diff --staged --name-only -- $(git rev-parse --show-toplevel)/active)
if [ -n "$staged_active" ]; then
    if ! git diff --quiet -- $staged_active; then
        read -r -p "Found unstaged changes in staged files from $(git rev-parse --show-toplevel)/active. Enter \"ignore\" to continue or anything else to exit: "  answer < /dev/tty
        if ! [ "${answer}" = "ignore" ] ; then
            exit 1
        fi
    fi
fi

if [ -z "${UCT_IGNORE_CHECK_SYNTAX}" ] ; then
    modified_files="$(mktemp -t ucthook-XXXXXXXXXX)"
    modified_json_files="$(mktemp -t ucthook-XXXXXXXXXX)"
    # check-syntax needs full path to files so prepend it via sed
    dir=$(git rev-parse --show-toplevel)
    git diff --cached --name-only --diff-filter=AM $against | sed "s|^|${dir}/|" > "${modified_files}"
    git diff --cached --name-only --diff-filter=AM $against | grep -E '\.json$' | sed "s|^|${dir}/|" > "${modified_json_files}"

    if ! "${UCT}/scripts/check-syntax" --verbose --filelist "${modified_files}" ; then
        read -r -p 'Found syntax errors. Enter "ignore" to continue or anything else to exit: ' answer < /dev/tty
        if ! [ "${answer}" = "ignore" ] ; then
            exit 1
        fi
    fi

    if [ -s "${modified_json_files}" ]; then
        if ! "${UCT}/scripts/check-json-syntax" "${modified_json_files}"; then
            echo "Found syntax errors on some .json files"
            exit 1
        fi
    fi

    if grep ignored/not-for-us.txt "${modified_files}"; then
        if ! "${UCT}/scripts/validate-nfu.py"; then
            echo "Found syntax errors on ignored/not-for-us.txt"
            exit 1
        fi
    fi

    for subdir in $SUBPROJECTS $EMBARGOED; do
        if [ -d "$subdir" ]; then
            subdir_untracked=$(git -C "$subdir" status --porcelain)
            if [ -n "${subdir_untracked}" ]; then
                echo "Please commit changes in $subdir:"
                <<< "$subdir_untracked" cut -d " " -f2-
            fi
        fi
    done
fi
