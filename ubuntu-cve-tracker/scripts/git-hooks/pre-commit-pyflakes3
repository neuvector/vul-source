#!/bin/bash
#
# SPDX-License-Identifier: GPL-3.0-only 
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# serve as a git pre-commit hook that will inspect pyflakes3 warnings.
#
# Author: Maria Emilia Torino <emilia.torino@canonical.com>
# Copyright 2019 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.


# This hook will inspect pyflakes3 warnings on the python files to be
# committed. The hook should exit with non-zero status after issuing an
# appropriate message to the user asking wether to ignore the warnings or
# not.


MODIFIED_FILES=$(git diff --name-only --cached)
WARNINGS=0
for file in ${MODIFIED_FILES}
do
    IS_PYTHON_SCRIPT=$(file $file |grep "Python script")
    if [[ $IS_PYTHON_SCRIPT != "" ]] ;
    then
      # if we only have pyflakes3 available then use it, otherwise if we
        # have both then use pyflakes only if python2 is specified as the
      # interpreter-
      PYFLAKES=pyflakes3
      if head -n1 $file | grep -Eq "python2" ; then
        if which pyflakes >/dev/null; then
          PYFLAKES=pyflakes
        fi
      fi
      $PYFLAKES $file
      WARNINGS=$((WARNINGS + $?))
    fi
done

if [[ $WARNINGS -gt 0 ]];
then
    read -p 'Found pyflakes3 warnings. Enter "ignore" to continue or anything else to exit: ' answer < /dev/tty
    if ! [ "${answer}" = "ignore" ] ; then
        exit 1
    fi
fi

