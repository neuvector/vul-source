#!/usr/bin/env python3
#
# SPDX-License-Identifier: GPL-3.0-only 
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# set CVE status to ignored for releases that are past end-of-life.
#
# Author: Paulo Flabiano Smorigo <pfsmorigo@canonical.com>
# Copyright 2023 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.


import cve_lib
import os
import pickle
import argparse

PICKLE_FILE="/tmp/ignored_eol_releases.pickle"

parser = argparse.ArgumentParser(
        description="Check for EOL releases and change the status to ignored for them")
parser.add_argument("-v", "--verbose", dest="verbose", default=False,
        action="store_true", help="verbose prints")
parser.add_argument("-n", "--dry-run", dest="dry_run", default=False,
        action="store_true", help="do no run")
parser.add_argument("-c", "--cache", dest="cache", default=False,
        action="store_true", help="use cache")
args = parser.parse_args()

if args.cache and os.path.exists(PICKLE_FILE):
    table, cves, rcves = pickle.load(open(PICKLE_FILE, "rb"))
else:
    cves, uems, rcves = cve_lib.get_cve_list_and_retired()
    table = cve_lib.load_all(cves, uems, rcves)
    if args.cache:
        pickle.dump([table, cves, rcves], open(PICKLE_FILE, "wb"))

for cve in cves + rcves:
    filepath = cve_lib.find_cve(cve)
    for pkg in table[cve]["pkgs"]:
        for rel in table[cve]["pkgs"][pkg]:
            state, details = table[cve]["pkgs"][pkg][rel]
            if rel in cve_lib.eol_releases and state == "needed":
                # details = f"end of standard support, was {state} [{details}]"
                details = "end of standard support"
                state = "ignored"
                if args.verbose:
                    print(f"{cve} {pkg} {rel} {state} {details}")
                if not args.dry_run:
                    cve_lib.update_state(filepath, pkg, rel, state, details)
