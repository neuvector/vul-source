#!/bin/python3
#
# SPDX-License-Identifier: GPL-3.0-only 
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# take a list of binary packages and determine what source packages produce 
# those binaries.
#
# Author: Mike Salvatore <mike.salvatore@canonical.com>
# Copyright 2005 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.

import argparse
import source_map
import sys

def which_source(srcmap, pkg, release):
    source = ("", "")
    if pkg in srcmap[release]:
        try:
            tmp_source = (srcmap[release][pkg]['source'], srcmap[release][pkg]['section'])
        except KeyError: # package was in list for the release but there was no source
            # so most likely the source name is the same as the package name
            tmp_source = (pkg, srcmap[release][pkg]['section'])

        if not source[0] or tmp_source[1] == "universe":
            source = tmp_source

    if source[0]:
        return source

    # this package wasn't in any source map most likely because it is
    # packaged only for an EOL'd release such as precise
    return ('unknown', 'unknown')

parser = argparse.ArgumentParser(description="Takes a list of binary packages "\
        "and determines what source packages produce those binaries.")
parser.add_argument("release" , action="store", help="An Ubuntu release")
parser.add_argument("bin_list_path" , action="store", help="Path to a file containing a list of binaries")

opt = parser.parse_args()

try:
    srcmap = source_map.load('packages', releases=[opt.release])
    source_packages = set()
    with open(opt.bin_list_path) as fp:
        binary_package = fp.readline().strip()
        while binary_package:
            source = which_source(srcmap, binary_package, opt.release)
            source_packages.add(source)
            binary_package = fp.readline().strip()

    for sp in sorted(source_packages):
        print(sp[0])
except KeyError as ke:
    print("KeyError detected. It's possible that the specified Ubuntu release" \
            " is nonexistant or has reached end-of-life. Key=%s" % str(ke),
           file=sys.stderr)
