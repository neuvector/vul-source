#!/bin/sh
#
# SPDX-License-Identifier: GPL-3.0-only 
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# download a specified USN or pkg-cache database 
#
# Author: Jamie Strandboge <jamie@ubuntu.com>
# Copyright 2012 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.


set -e

db="$1"
dbtype="$2"

if [ -z "$db" ]; then
    echo "Must specify a db. Eg 'database.pickle.bz2' or 'jammy-pkg-cache.bz2'" >&2
    exit 1
fi

for i in "$db" "$db".sha256 ; do
    echo "= Fetching $i ="
    # Fetch from people, instead of usn.ubuntu.com, because the version of the
    # USN database on usn.ubuntu.com isn't updated until the Jenkins deployment
    # job is executed to redeploy the site
    if [ -z "$dbtype" ]  || [ "$dbtype" = "usn" ]; then
        wget -N https://people.canonical.com/~ubuntu-security/usn/"$i"
    elif [ "$dbtype" = "pkg-cache" ]; then
        wget -N https://security-metadata.canonical.com/pkg-cache/"$i"
    else
        echo "The types of db accepted are either 'usn' or 'pkg-cache'"
        exit 1
    fi
done

echo "= Verifiying $i ="
sha256sum -c ./"$db".sha256

if echo "$db" | grep -q 'bz2$' ; then
    echo ""
    echo "= Uncompressing $db ="
    bzip2 -d -f -k ./"$db"
fi

echo "Download complete. File saved to '$(basename "$db" .bz2)'"
