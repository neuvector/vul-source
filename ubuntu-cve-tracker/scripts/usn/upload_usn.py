# -*- coding: utf-8 -*-
# Module containing functions for uploading a USN to the USN repo and creating
# the relevant PR
#
# Author: Nick Galanis <nick.galanis@canonical.com>
# Copyright (C) 2025 Canonical Ltd.
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, "Version" 3 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.
#
import argparse
import configparser
import os
import shutil
import subprocess
from git import Repo, GitCommandError

from utils import usn_number, USN_GH, new_usn_dir, print_info, print_error, print_success

def run_command(command, cwd=None):
    result = subprocess.run(command, shell=True, cwd=cwd, capture_output=True, text=True)
    if result.returncode != 0:
        print_error(f"Command failed: {command}")
        print_error(result.stderr)
        exit(1)

def push_to_usn_repo(packages, no_pr):
    branch_name = f"USN-{usn_number}"
    # copy the file to the actual dir for uploading
    os.makedirs("usn-json", exist_ok=True)
    final_file_path = os.path.join(USN_GH, f"usn-json/{branch_name}.json")
    shutil.copy(os.path.join(new_usn_dir, f"{branch_name}.json"), final_file_path)

    commit_message = f"Add {branch_name} for {packages}"
    merge_request_title = commit_message

    desc_path = os.path.join(new_usn_dir, f"USN-{usn_number}-template.yaml")

    # Read .git/config
    config = configparser.ConfigParser()
    config.read(os.path.join(USN_GH, '.git', 'config'))

    try:
        repo = Repo(USN_GH)
        origin = repo.remote(name='origin')

        # Ensure we're on the main branch
        repo.git.checkout('main')

        # Pull the latest changes
        origin.pull()

        # Create and checkout a new branch
        repo.git.checkout('-b', branch_name)

        # Add the file to staging
        repo.git.add(final_file_path)

        # Commit the changes
        repo.index.commit(commit_message)

        # Push the new branch to the remote repository
        origin.push(refspec=f'{branch_name}:{branch_name}')

    except GitCommandError as e:
        print_error(f"An error occurred: {e}")

    with open(desc_path, "r") as file:
        description = file.read()

    # Create the PR using GH CLI
    if not no_pr:
        try:
            with open(desc_path, "r") as file:
                description = file.read()
        except FileNotFoundError:
            print_error("Error: The template YAML file of the USN was not found.")
            exit(1)
        print_info("Trying to create PR...")
        run_command(f'gh pr create --title "{merge_request_title}" --body "{description}" --base main --head {branch_name}', cwd=USN_GH)
        print_success("PR created in USN repo!")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Send an email to the ubuntu-security-announce list with the new USN.")

    # optional arguments
    parser.add_argument("--packages", help="comma separated list of packages that will be presented in the USN.", default=None)
    parser.add_argument("--no-pr", action="store_true", help="Don't create the PR in GH.")

    args = parser.parse_args()

    push_to_usn_repo(args.packages, args.no_pr)