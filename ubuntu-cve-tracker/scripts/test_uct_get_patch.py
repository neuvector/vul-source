import pytest
from uct_get_patch import get_download_link, get_tag_match
import apt_pkg

# Needed to compare versions for tag matching tests
apt_pkg.init_config()
apt_pkg.init_system()

# To add new tests, manually go to a link and find the direct patch link on that page
# Add both links to the list of parametrizations with a description of the page host/type
@pytest.mark.parametrize(
    "input_link,download_link",
    [
        pytest.param(
            "https://github.com/tianocore/edk2/commit/4c4ceb2ceb80c42fd5545b2a4bd80321f07f4345",
            "https://github.com/tianocore/edk2/commit/4c4ceb2ceb80c42fd5545b2a4bd80321f07f4345.patch",
            id="Basic GitHub Commit Link",
        ),
        pytest.param(
            "https://gitlab.com/qemu-project/qemu/-/commit/fb1c2aaa981e0a2fa6362c9985f1296b74f055ac",
            "https://gitlab.com/qemu-project/qemu/-/commit/fb1c2aaa981e0a2fa6362c9985f1296b74f055ac.patch",
            id="Basic GitLab Commit Link",
        ),
        pytest.param(
            "https://git.savannah.nongnu.org/cgit/dmidecode.git/commit/?id=6ca381c1247c81f74e1ca4e7706f70bdda72e6f2",
            "https://git.savannah.nongnu.org/cgit/dmidecode.git/patch/?id=6ca381c1247c81f74e1ca4e7706f70bdda72e6f2",
            id="Savannah Commit Link",
        ),
        pytest.param(
            "https://git.moodle.org/gw?p=moodle.git;a=commit;h=cd2d23d35693b039aad3e20b978ffb694f30b994",
            "https://git.moodle.org/gw?p=moodle.git;a=patch;h=cd2d23d35693b039aad3e20b978ffb694f30b994",
            id="Moodle Commit Link",
        ),
        pytest.param(
            "https://salsa.debian.org/openstack-team/services/barbican/-/commit/a0859b04a217d5578eaaa54df888cb6d8b817ddc",
            "https://salsa.debian.org/openstack-team/services/barbican/-/commit/a0859b04a217d5578eaaa54df888cb6d8b817ddc.patch",
            id="Salsa Commit Link",
        ),
        pytest.param(
            "https://www.privoxy.org/gitweb/?p=privoxy.git;a=commitdiff;h=0e668e9409c",
            "https://www.privoxy.org/gitweb/?p=privoxy.git;a=patch;h=0e668e9409c",
            id="GitWeb Commit Link (1)",
        ),
        pytest.param(
            "https://sourceware.org/git/gitweb.cgi?p=glibc.git;h=4d27d4b9a188786fc6a56745506cec2acfc51f83",
            "https://sourceware.org/git/gitweb.cgi?p=glibc.git;h=4d27d4b9a188786fc6a56745506cec2acfc51f83;a=patch",
            id="GitWeb Commit Link (2)",
        ),
        pytest.param(
            "http://git.videolan.org/?p=ffmpeg.git;a=shortlog;h=673fce6d40d9a594fb7a0ea17d296b7d3d9ea856",
            "http://git.videolan.org/?p=ffmpeg.git;a=patch;h=673fce6d40d9a594fb7a0ea17d296b7d3d9ea856",
            id="GitWeb Shortlog Link",
        ),
        pytest.param(
            "https://gcc.gnu.org/git/?p=gcc.git;a=log;h=9234cdca6ee88badfc00297e72f13dac4e540c79",
            "https://gcc.gnu.org/git/?p=gcc.git;a=patch;h=9234cdca6ee88badfc00297e72f13dac4e540c79",
            id="GitWeb Log Link",
        ),
        pytest.param(
            "https://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=d6a61cb3bef3c8fbc35c2a6182e75a8c1d351e41",
            "https://git.postgresql.org/gitweb/?p=postgresql.git;a=patch;h=d6a61cb3bef3c8fbc35c2a6182e75a8c1d351e41",
            id="GitWeb CommitDiff Link",
        ),
        pytest.param(
            "https://sourceware.org/git/?p=binutils-gdb.git;a=tree;h=e6a6f1ce759adb9afb1f515aa9347d06541b0f16;hb=8abac8031ed369a2734b1cdb7df28a39a54b4b49",
            "https://sourceware.org/git/?p=binutils-gdb.git;a=patch;hb=8abac8031ed369a2734b1cdb7df28a39a54b4b49",
            id="GitWeb Tree Link",
        ),
        pytest.param(
            "https://git.openldap.org/openldap/openldap/-/commit/8e1fda85532a3c74276df38a42d234dcdfa1e40d",
            "https://git.openldap.org/openldap/openldap/-/commit/8e1fda85532a3c74276df38a42d234dcdfa1e40d.patch",
            id="OpenLDAP Link",
        )
    ],
)
def test_link_transformation(input_link: str, download_link: str) -> None:
    """
    Test the output for different links passed to the get_download_link method
    """
    transformed_link, tag = get_download_link(input_link)
    assert transformed_link == download_link
    



# TODO: Currently release name argument is unused, add test/code for this
@pytest.mark.parametrize(
    "release, release_version, tags, correct_tag",
    [
        # List of versions, should take the lowest version higher than the releases version
        pytest.param("esm-infra_bionic", "1.0.0", ["0.6.3", "1.0.1", "2.4", "1.0.8"], "1.0.1", id="Version Selection"),

        # No versions higher than given version but None tag present so it should be selected
        pytest.param("jammy", "4.5.3", ["1.2.3", "4.4.9", "3.7.8", "None"], "None", id="None Selection"),

        # TODO: When no appropriate version exists and no None tag exists, we should raise an issue 
        # (return None for this test)
        # Currently will take the first item from the tag list. This test should be updated when
        # this is implemented
        pytest.param("esm-infra-legacy/trusty", "1.0.0", ["0.1.2", "0.5.3"], "0.1.2", id="No Matching Tag"),
    ]
)
def test_tag_matching(release: str, release_version: str, tags: list[str], correct_tag: str) -> None:
    tag_match = get_tag_match(release, release_version, tags)
    assert tag_match == correct_tag
