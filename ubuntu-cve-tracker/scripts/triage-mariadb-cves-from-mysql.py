#!/usr/bin/env python3
#
# SPDX-License-Identifier: GPL-3.0-only-only
#
# Triages MariaDB CVEs that affect MySQL but not MariaDB, from a URL provided
# by MariaDB upstream.
#
# Author: Hlib Korzhynskyy <hlib.korzhynskyy@canonical.com>
# Copyright 2025 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.

import argparse
import re
import subprocess
import shutil
import os

import cve_lib

parser = argparse.ArgumentParser()
parser.add_argument("-v", "--verbose", help="Displays more detailed information about modified/skipped CVEs", action="store_true")
args = parser.parse_args()

URL = "https://mariadb.com/docs/server/security/securing-mariadb/security-vulnerabilities-in-oracle-mysql-that-did-not-exist-in-mariadb"

website_text = subprocess.run(["w3m", "-dump", URL], encoding="utf-8", capture_output=True).stdout
cve_regex = re.compile(r"CVE-[0-9]{4}-[0-9]{4,}")
# cves = cve_regex.findall(website_text)
cves = []
for line in website_text.split("\n"):
    if cve_match := cve_regex.findall(line):
        if len(cve_match) > 1:
            print("2+ CVEs in the same line detected on the website. This should not happen.")
            print(line)
        else:
            cves.extend(cve_match)


# This line matches entries in UCT for mariadb
#  Example: esm-apps/jammy_mariadb-10.6: needs-triage
mariadb_uct_entry_regex = re.compile(r"^[a-z\/\-]+_mariadb(|-[0-9\.]+): (needs-triage|needed|deferred)$")
# This line matches entries in UCT after update
# This is needed to check whether the line was properly updated.
mariadb_uct_updated_entry_regex = re.compile(r"^[a-z\/\-]+_mariadb(|-[0-9\.]+): not-affected \(this mysql cve does not affect mariadb\)$")

# CVEs which location in UCT was not found through cve_lib.find_cve
location_not_found_number = 0
location_not_found_cves = []
# CVEs that were modified by the script
modified_number = 0
modified_cves = []
# If the script modified something it shouldn't have
errorred_out = False

for cve in cves:
    try:
        cve_location = cve_lib.find_cve(cve)
    except:
        location_not_found_number += 1
        location_not_found_cves.append(cve)
        continue
    if "active" not in cve_location:
        continue

    new_file = ""
    shutil.copy(cve_location, f"{cve_location}.bkp")
    with open(cve_location, "r", encoding="utf-8") as f:
        modified = False
        for line in f.readlines():
            if mariadb_uct_entry_regex.match(line):
                modified = True
                line = re.sub(r"(needs-triage|needed|deferred)", "not-affected (this mysql cve does not affect mariadb)", line)
            new_file += line
        if modified:
            modified_number += 1
            modified_cves.append(cve)

    with open(cve_location, "w") as f:
        f.write(new_file)

    # Now we check that we modified the right thing
    with open(cve_location, "r") as f_new, open(f"{cve_location}.bkp", "r") as f_old:
        for line_new, line_old in zip(f_new.readlines(), f_old.readlines()):
            if line_new != line_old and mariadb_uct_updated_entry_regex.match(line_new) == None:
                print(f"ERROR: Something went wrong when modifying {cve}. Please check the {cve_location} file, with the corresponding backup file")
                print(f"old line: {repr(line_old)}")
                print(f"new line: {repr(line_new)}")
                errorred_out = True
                break

    if errorred_out:
        break
    else:
        os.unlink(f"{cve_location}.bkp")

print("\nReport:")
if args.verbose:
    print(f"Could not find location of the following {location_not_found_number} CVEs:")
    print(" ".join(location_not_found_cves))
    print(f"\nModified the following {modified_number} CVEs:")
    print(" ".join(modified_cves))
else:
    print(f"Could not find location of {location_not_found_number} CVEs.")
    print(f"Modified {modified_number} CVEs.")
