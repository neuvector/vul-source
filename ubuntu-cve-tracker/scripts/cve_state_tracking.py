#!/usr/bin/env python3
import yaml, sys, os
import cve_lib

def load_cve_snapshopt_db(snapshot_file):
        ''' loads in a local snapshot of cves '''

        # check if the snapshot_file does not exist
        if not os.path.exists(snapshot_file):
                # touching file to create it
                with open(snapshot_file, 'w') as create_file:
                        pass

                # returning empty dict of CVEs
                return {}

        with open(snapshot_file, 'r') as inF:
                cves = yaml.safe_load(inF)

        # handling case of an empty snapshot file
        if cves == None:
                cves = {}

        return cves

def write_cve_snapshopt_db(snapshot_file, cve_d):
        ''' overwrites the local snapshot of cves with the provided cve dict '''

        untracked_keys = ("public_date", "packages", "ubuntu_priority_reason")

        # removing keys we do not need to track to minimize the size of the snapshot_file
        for cve in cve_d:
                for key in untracked_keys:
                        del cve_d[cve][key]

        with open(snapshot_file, 'w') as outF:
                yaml.dump(cve_d, outF)

def get_cveinfo():
	''' returns a dict of cves and their corresponding data from $UCT '''

	active_cves, embargoed_cves = cve_lib.get_cve_list()

	table, priority, updated_cves, namemap, cveinfo = cve_lib.load_table(active_cves, embargoed_cves)

        # clearing out embargoed cves
	for cve in embargoed_cves:
                cveinfo.pop(cve)

	return cveinfo

def parse_cveinfo(cveinfo):
        ''' returns a dict of cves and their corresponding values (that we are interested in) '''

        cve_d = {}

        for cve in cveinfo:
                priority = cveinfo[cve]["Priority"][0].upper().strip()
                ubuntu_priority_reason = cveinfo[cve]["Priority"][1].strip()

                public_date = cveinfo[cve]["PublicDate"].strip()
                packages = cveinfo[cve]["pkgs"]

                cve_d[cve] = {"priority":priority, "severities":{}, "public_date":public_date, "packages":packages, "ubuntu_priority_reason":ubuntu_priority_reason}

                for entry in cveinfo[cve]["CVSS"]:
                        source = entry["source"].strip()
                        version = entry["vector"][:entry["vector"].index('/')].strip()
                        severity = entry["baseSeverity"].upper().strip()

                        cve_d[cve]["severities"][f"{source}:{version}"] = severity

        return cve_d
