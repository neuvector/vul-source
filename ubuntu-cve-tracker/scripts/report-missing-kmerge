#!/bin/sh
# Copyright 2009-2024 Canonical, Ltd.
# Authors:
#  Jamie Strandboge <jamie@canonical.com>
#  Kees Cook <kees@ubuntu.com>
#  Marc Deslauriers <marc.deslauriers@canonical.com>
#  Steve Beattie <steve.beattie@canonical.com>

# Based mostly on the kernel_team_merge() from process_cves, except
# without the actual merging; i.e. it doesn't make any changes to the
# local checkout.

set -e

if [ -z "${UCT}" ] ; then
	echo "\$UCT is not set, aborting"
	exit 1
fi

if ! [ -d "${UCT}" ] ; then
	echo "${UCT} is not a directory, aborting"
	exit 1
fi

cd "${UCT}"

short_output=
reverse_output=
kernel_branch="for-security"

help() {
    cat <<EOM
usage: report-missing-kmerge [-s] [-o] [-r] [-b BRANCH_NAME]

Report unmerged commits from the kernel team for triaging kernel cves

    -s  short output: only show git commit messages, not full
        diff output
    -o  oneline output: only show git --online output, not full diff
    -r  reverse order of reported commits, oldest -> newest
    -b  branch from the kernel team's tree to use: default is 'for-security'
    -h  this message
EOM
}

while getopts "srhob:" opt ; do
    case "$opt" in
	s) short_output="yes";;
	o) oneline_output="yes";;
	r) reverse_output='yes';;
	b) kernel_branch="$OPTARG";;
	h) help; exit 0;;
	?) help; exit 1;;
    esac
done

kernel_team_merge() {
    kernel_remote='kernel-team'
    kernel_url="https://git.launchpad.net/~canonical-kernel-team/ubuntu-cve-tracker"
    git_show_args=
    git_order_args=

    if ! (git remote | grep -q "^${kernel_remote}$") ; then
        git remote add "${kernel_remote}" "${kernel_url}"
    fi

    if [ "${oneline_output}" = "yes" ] ; then
        git_show_args="-s --oneline"
    elif [ "${short_output}" = "yes" ] ; then
        git_show_args="-s"
    fi

    if [ "${reverse_output}" = "yes" ] ; then
        git_order_args="--reverse"
    fi

    git fetch -q "${kernel_remote}"

    if ! git show-ref --verify --quiet "refs/remotes/${kernel_remote}/${kernel_branch}"; then
        echo "Branch ${kernel_branch} does not exist in kernel team's tree"
        exit 1
    fi

    if ! [ "$(git rev-list HEAD..${kernel_remote}/${kernel_branch} --count)" -eq 0 ] ; then
        echo "Missing merge commits from the Kernel Team's CVE Tree"
        git rev-list ${git_order_args} HEAD..${kernel_remote}/${kernel_branch} | xargs git show ${git_show_args}

	echo ""
	echo "Please use uct_kernel_merge_commit() (from scripts/dot.uct-functions.sh)"
	echo "after reviewing these changes to merge these change"
    fi
}

kernel_team_merge
