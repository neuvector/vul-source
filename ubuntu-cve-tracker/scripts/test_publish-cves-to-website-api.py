#!/usr/bin/env pytest-3
#
# SPDX-License-Identifier: GPL-3.0-only 
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# perform some simple tests for publish-cves-to-website-api.py
#
# Author: Paulo Flabiano Smorigo <pfsmorigo@canonical.com>
# Copyright 2023 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.

import argparse
from argparse import Namespace

# Dependencies: python3-macaroonbakery

import cve_lib
import json
import os
import importlib
import pytest

publish_cves = importlib.import_module("publish-cves-to-website-api")

TEST_DATA_DIR = "test"
PARSE_OKAY_TESTS = [
    file
    for file in os.listdir("test/website_api")
    if file.startswith("use_") and not file.endswith(".json")
]


class TestWebSiteAPI:
    """pytest website api dry run"""

    def __check_simple_okay(self, cve_test_file):
        """test website api dry run"""
        _test_file = os.path.join(TEST_DATA_DIR, "website_api", cve_test_file)
        assert os.path.exists(_test_file)
        # main expects a Namespace
        flag_list = ["--dry-run", "--ignore-filename-check", _test_file]
        parser = publish_cves.get_argparser()
        payload = publish_cves.main(parser.parse_args(flag_list))
        assert payload is not None
        with open(f"{_test_file}.json", "rt") as file:
            payload_json = json.load(file)
        assert payload_json is not None
        assert payload == payload_json

    @pytest.mark.parametrize("cve_test_file", PARSE_OKAY_TESTS)
    def test_simple_okay(self, cve_test_file):
        """parameterize website api dry run"""
        self.__check_simple_okay(cve_test_file)

    def test_get_patches(self):
        """test publish_cves.get_patches()"""
        test_file = "active/CVE-2023-48795"
        assert os.path.exists(test_file)
        cve_data = cve_lib.load_cve(test_file)
        patches = publish_cves.get_patches(cve_data)
        assert patches == {
            "openssh": [
                "upstream: https://github.com/openssh/openssh-portable/commit/1edb00c58f8a6875fad6a497aa2bacf37f9e6cd5"
            ],
            "dropbear": [
                "upstream: https://github.com/mkj/dropbear/commit/6e43be5c7b99dbee49dc72b6f989f29fdd7e9356"
            ],
            "golang-go.crypto": [
                "upstream: https://github.com/golang/crypto/commit/9d2ee975ef9fe627bf0a6f01c1f69e8ef1d4f05d"
            ],
            "snapd": ["upstream: https://github.com/snapcore/snapd/pull/14143"],
            "lxd": [],
            "libssh": [
                "upstream: https://gitlab.com/libssh/libssh-mirror/-/commit/4cef5e965a46e9271aed62631b152e4bd23c1e3c",
                "upstream: https://gitlab.com/libssh/libssh-mirror/-/commit/0870c8db28be9eb457ee3d4f9a168959d9507efd",
                "upstream: https://gitlab.com/libssh/libssh-mirror/-/commit/5846e57538c750c5ce67df887d09fa99861c79c6",
                "upstream: https://gitlab.com/libssh/libssh-mirror/-/commit/89df759200d31fc79fbbe213d8eda0d329eebf6d",
            ],
            "libssh2": [
                "upstream: https://github.com/libssh2/libssh2/commit/d34d9258b8420b19ec3f97b4cc5bf7aa7d98e35a",
                "upstream: https://github.com/libssh2/libssh2/pull/1291",
            ],
            "openssh-ssh1": [],
            "paramiko": [
                "upstream: https://github.com/paramiko/paramiko/commit/be3ffc18cc466e0b0a877d716721353c12561bcc",
                "upstream: https://github.com/paramiko/paramiko/commit/4c7f0410c533cdf0df2890512237961f934f5ab9",
                "upstream: https://github.com/paramiko/paramiko/commit/773a174fb1e40e1d18dbe2625e16337ea401119e",
                "upstream: https://github.com/paramiko/paramiko/commit/c32be441a5ff0dc4914b22d6d1efa392aebe862f",
                "upstream: https://github.com/paramiko/paramiko/commit/f4dedacb9040d27d9844f51c81c28e0247d3e4a3",
                "upstream: https://github.com/paramiko/paramiko/commit/73f079f5a4bbba7f3048dadbe05b24242206745e",
                "upstream: https://github.com/paramiko/paramiko/commit/75e311d3c0845a316b6e7b3fae2488d86ad5a270",
                "upstream: https://github.com/paramiko/paramiko/commit/fa46de7feeeb8a01dc471581a0258252ce4f2db6",
                "upstream: https://github.com/paramiko/paramiko/commit/8dcb237f0ee095b1d8b26765c3d41d0ab6963be9",
                "upstream: https://github.com/paramiko/paramiko/commit/58785d29c47570fa700e096d16b9a0d3a6069048",
                "upstream: https://github.com/paramiko/paramiko/commit/96db1e2be856eac66631761bae41167a1ebd2b4e",
                "upstream: https://github.com/paramiko/paramiko/commit/33508c920309860c4a775be70f209c2a400e18ec",
                "upstream: https://github.com/paramiko/paramiko/commit/30b447b911c39460bbef5e7834e339c43a251316",
                "upstream: https://github.com/paramiko/paramiko/commit/3e4bdf998f5b1508322234a527e8fa432220368b",
            ],
            "putty": [
                "upstream: https://git.tartarus.org/?p=simon/putty.git;a=commit;h=9e099151574885f3c717ac10a633a9218db8e7bb",
                "upstream: https://git.tartarus.org/?p=simon/putty.git;a=commit;h=f2e7086902b3605c96e54ef9c956ca7ab000010e",
                "upstream: https://git.tartarus.org/?p=simon/putty.git;a=commit;h=9fcbb86f715bc03e58921482efe663aa0c662d62",
                "upstream: https://git.tartarus.org/?p=simon/putty.git;a=commit;h=244be5412728a7334a2d457fbac4e0a2597165e5",
                "upstream: https://git.tartarus.org/?p=simon/putty.git;a=commit;h=58fc33a155ad496bdcf380fa6193302240a15ae9",
                "upstream: https://git.tartarus.org/?p=simon/putty.git;a=commit;h=0b00e4ce26d89cd010e31e66fd02ac77cb982367",
                "upstream: https://git.tartarus.org/?p=simon/putty.git;a=commit;h=fdc891d17063ab26cf68c74245ab1fd9771556cb",
                "upstream: https://git.tartarus.org/?p=simon/putty.git;a=commit;h=b80a41d386dbfa1b095c17bd2ed001477f302d46",
            ],
            "proftpd-dfsg": [],
            "python-asyncssh": [
                "upstream: https://github.com/ronf/asyncssh/commit/0bc73254f41acb140187e0c89606311f88de5b7b"
            ],
            "filezilla": [],
        }
