#!/bin/bash
#
# SPDX-License-Identifier: GPL-3.0-only 
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# report kernel CVEs that do not have a fix commit entry identfied.
#
# Author: Steve Beattie <steve.beattie@canonical.com>
# Copyright 2018 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.


set -e
export LANG=C

. "$HOME"/.ubuntu-cve-tracker.conf

if [ -z "${linux_kernel_cve_tracker}" ] ; then
    echo "\$linux_kernel_cve_tracker is undefined in $HOME/.ubuntu-cve-tracker.conf,"
    echo "Please git clone https://github.com/nluedtke/linux_kernel_cves.git"
    echo "and add the following to $HOME/.ubuntu-cve-tracker.conf with"
    echo "the path to that clone:"
    echo
    echo "# path to a copy of the linux kernel cve tracker from"
    echo "# https://github.com/nluedtke/linux_kernel_cves.git"
    echo "linux_kernel_cve_tracker=PATH_TO_CLONE"
    echo
fi

if [ -z "${debian_kernel_cve_tracker}" ] ; then
    echo "\$debian_kernel_cve_tracker is undefined in $HOME/.ubuntu-cve-tracker.conf,"
    echo "Please git clone https://salsa.debian.org/kernel-team/kernel-sec.git"
    echo "and add the following to $HOME/.ubuntu-cve-tracker.conf with"
    echo "the path to that clone:"
    echo
    echo "# path to a copy of the debian kernel cve tracker from"
    echo "# https://salsa.debian.org/kernel-team/kernel-sec.git"
    echo "debian_kernel_cve_tracker=PATH_TO_CLONE"
    echo
fi

_CVES=$(cd "$UCT" && grep -lr 'break-fix:.*-$' active/ | sort)
for _CVE in ${_CVES} ; do
    echo "${_CVE}"
    echo -n ' ' && grep 'break-fix:.*-$' "${_CVE}"
    CVE="${_CVE##active/}"
    if grep -q "${CVE}:" "${linux_kernel_cve_tracker}/data/CVEs.txt" ; then
        echo -n '  ' && grep "${CVE}:" "${linux_kernel_cve_tracker}/data/CVEs.txt"
    fi
    for _dir in active retired ; do
        if [ -f "${debian_kernel_cve_tracker}/${_dir}/${CVE}" ] ; then
            echo -n '  ' && grep "^upstream:" "${debian_kernel_cve_tracker}/${_dir}/${CVE}"
        fi
    done
done
