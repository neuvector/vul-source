#!/bin/bash
#
# SPDX-License-Identifier: GPL-3.0-only 
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# display the history of CVEs related to the specified package.
#
# Author: Jamie Strandboge <jamie@ubuntu.com>
# Copyright 2025 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.

set -e

# finding ubuntu-cve-tracker
UCT_DIR="$( dirname $( dirname "${BASH_SOURCE[0]}" ))"

showfull="no"
release=
showstatus="no"
activeonly="no"

help() {
  echo "Usage: ./scripts/pkg_history [-f] [-r release] pkgname1 pkgname2 ..."
  echo "   or: ./scripts/pkg_history -s -r release pkgname1 pkgname2 ..."
  exit $1
}

while getopts "ahfr:s" opt; do
   case "$opt" in
       f) showfull="yes";;
       r) release="$OPTARG";;
       s) showstatus="yes";;
       a) activeonly="yes";;
       h) help 0;;
       ?) help 1;;
   esac
done

if [ "$showstatus" = "yes" ]; then
    if [ -z "$release" ]; then
        help 2
    fi
    if [ "$showfull" = "yes" ]; then
        help 3
    fi
fi

shift $((OPTIND - 1))

if [ -z "$1" ]; then
	echo "Need to specific a source package name"
	exit 1
fi

for pkg in "$@"; do
    pattern="_${pkg}: "
    if [ -n "$release" ]; then
        pattern="${release}${pattern}"
    fi

    echo "= $pkg ="
    dirs="retired ignored active"
    if [ "${activeonly}" = "yes" ] ; then
    	dirs="active"
    fi
    for d in ${dirs} ; do
        for cve in `grep "$pattern" -r ${UCT_DIR}/${d} --include=CVE-* | \
            cut -d ':' -f 1 | \
            rev | \
            cut -d '/' -f 1 | \
            rev | \
            sort -u` ; do
            if [ "$showfull" = "yes" ]; then
                echo ""
                cat "${UCT_DIR}/$d/$cve"
                echo ""
            else
                if [ "$showstatus" = "yes" ]; then
                    status=$(grep "^$pattern" "${UCT_DIR}/${d}/${cve}" | cut -d ':' -f 2-)
                    echo "${cve}${status}"
                else
                    echo "$cve"
                fi
            fi
        done
    done
    if [ "$showfull" = "no" ]; then
        echo ""
    fi
done
