#!/bin/bash
#
# SPDX-License-Identifier: GPL-3.0-only 
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# duplicate the status of a package(s) from one release to
# another where it is listed as DNE originally
#
# Author: Alex Murray <alex.murray@canonical.com>
# Copyright 2020 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.


src="$1"
shift
if [ -z "$src" ]; then
  echo "Which release to copy status from?" >&2
  exit 1
fi
dst="$1"
shift
if [ -z "$dst" ]; then
  echo "Which release to copy status to?" >&2
  exit 1
fi

for pkg in "$@"; do
  echo "Duplicating status from ${src} to ${dst} for ${pkg} where was DNE for ${dst}"
  # find files to change
  for file in $(grep -l '^'"${dst}_${pkg}"': DNE' active/CVE-* retired/CVE-*); do
    status=$(grep '^'"${src}_${pkg}"': ' "${file}" | cut -f2- -d' ')
    if [ ! -z "${status}" ]; then
      echo "Duplicating status ${status} from ${src} to ${dst} in ${file}"
      sed -i -e 's/^\('"${dst}_${pkg}"'\): \(DNE\)/\1: '"${status}"'/' "${file}"
    else
      echo "Failed to extract status from ${src} in ${file}"
    fi
  done
done
