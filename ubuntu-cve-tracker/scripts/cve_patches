#!/usr/bin/perl -w
#
# SPDX-License-Identifier: GPL-3.0-only 
#
# This file is part of the Ubuntu CVE Tracker (UCT) scripts, its purpose is to
# list upstream patches for active CVEs.
#
# Author: Jamie Strandboge <jamie@ubuntu.com>
# Author: Kees Cook <kees@ubuntu.com>
# Copyright 2005 Canonical Ltd.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 3, as published by the
# Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranties of MERCHANTABILITY,
# SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.


use strict;

my %debdiff;
my %vendor;
my %upstream;
my %patch;	# catchall
my %cves;
my %seen;

my $supported = 0;
if (@ARGV > 0) {
	if ($ARGV[0] eq "-s" or $ARGV[0] eq "--supported" or $ARGV[0] eq "-S") {
		$supported = 1;
	}
}

open CVES, "./scripts/ubuntu-table --supported |" or die;
my @table = <CVES>;	# read the whole file
close(CVES);

foreach my $row (@table) {
	$row =~ /^\s/ and next;
	$supported and $row !~ /SUPPORTED/ and next;

	my @parts = split(/\s+/, $row);

	my $cve = $parts[0];
	exists($seen{$cve}) and next;	# skip CVE files we've looked at

	my $show = 0;
	my $n = 0;
	for my $status (@parts) {
		if ($n > 1) {
			if ($status eq "needed" or $status eq "needs-triage" or $status eq "pending") {
				$show = 1;
				last;
			}
		}
		$n++;
	}
	$show or next;

	my $pkgname = $parts[1];
	$pkgname =~ s/://;

	my $fn = "./active/$cve";
	-s $fn or $fn = "./embargoed/$cve";
	open CVE, $fn or (warn "Couldn't open '$fn'\n" and next);

	my $count = 0;
	my $in_patches = 0;
	while (<CVE>) {
		my $line = $_;
		chomp($line);
		if (/^\QPatches_$pkgname:\E/) {
			$in_patches = 1;
			next;
		}
		$in_patches or next;
		if ($line !~ /^\s+/) {
			$in_patches = 0;
			next;
		}

		if ($line =~ /^\s+debdiff:/) {
			$debdiff{$pkgname . "_" . $cve} .= "$line\n";
		} elsif ($line =~ /^\s+vendor:/) {
			$vendor{$pkgname . "_" . $cve} .= "$line\n";
		} elsif ($line =~ /^\s+upstream:/) {
			$upstream{$pkgname . "_" . $cve} .= "$line\n";
		} elsif ($line =~ /^\s+[a-z]+:/) {
			$patch{$pkgname . "_" . $cve} .= "$line\n";
		} else {
			# if get here, then have a malformed line
			print STDERR "Skipping $cve: $line \n";
			next;
		}
		$cves{$pkgname . "_" . $cve} = 1;
	}
	close(CVE);
	$seen{$cve} = 1;
}

foreach my $k (sort keys(%cves)) {
	my ($pkg, $cve) = split(/_/, $k);
	print "$pkg ($cve)\n";
	defined ($debdiff{$k}) and print "$debdiff{$k}";
	defined ($vendor{$k}) and print "$vendor{$k}";
	defined ($upstream{$k}) and print "$upstream{$k}";
	defined ($patch{$k}) and print "$patch{$k}";
	print "\n";
}


